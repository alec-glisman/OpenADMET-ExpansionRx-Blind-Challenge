<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="Task Affinity Grouping" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://github.com/alec-glisman/guide/task_affinity.html" />
<meta property="og:site_name" content="OpenADMET Challenge" />
<meta property="og:description" content="Table of Contents: Overview- Key Benefits, Algorithm Overview., Inter-Task Affinity Configuration (Paper-Accurate)- Mathematical Foundation, Key Differences from Legacy Approach, Inter-Task Affinit..." />
<meta property="og:image" content="https://github.com/alec-glisman/_static/images/logo.svg" />
<meta property="og:image:alt" content="OpenADMET Challenge" />
<meta name="description" content="Table of Contents: Overview- Key Benefits, Algorithm Overview., Inter-Task Affinity Configuration (Paper-Accurate)- Mathematical Foundation, Key Differences from Legacy Approach, Inter-Task Affinit..." />
<link rel="index" title="Index" href="../genindex.html"><link rel="search" title="Search" href="../search.html"><link rel="next" title="MLflow Artifacts Guide" href="mlflow_artifacts.html"><link rel="prev" title="Curriculum Learning Guide" href="curriculum.html">
        <link rel="prefetch" href="../_static/logo.svg" as="image">

    <link rel="shortcut icon" href="../_static/logo.svg"><!-- Generated with Sphinx 8.2.3 and Furo 2025.09.25 -->
        <title>Task Affinity Grouping - OpenADMET Challenge</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-dropdown.css?v=995e94df" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-bootstrap.min.css?v=21c0b90a" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  --color-brand-primary: #007A73;
  --color-brand-content: #C4C7F2;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #007A73;
  --color-brand-content: #C4C7F2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #007A73;
  --color-brand-content: #C4C7F2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">OpenADMET Challenge</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/logo.svg" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api/admet.html">ADMET Package API</a><input aria-label="Toggle navigation of ADMET Package API" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/admet.data.html">Data Pipeline (<code class="docutils literal notranslate"><span class="pre">admet.data</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/admet.model.html">Model Package (<code class="docutils literal notranslate"><span class="pre">admet.model</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/admet.plot.html">Visualization Tools (<code class="docutils literal notranslate"><span class="pre">admet.plot</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/admet.util.html">Utilities (<code class="docutils literal notranslate"><span class="pre">admet.util</span></code>)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">CLI Usage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Guides</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Development Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_sources.html">Data Sources &amp; Curation</a></li>
<li class="toctree-l1"><a class="reference internal" href="splitting.html">Dataset Splitting Methodology</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="config_reference.html">Configuration File Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="modeling.html">Modeling Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="hpo.html">Hyperparameter Optimization Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="curriculum.html">Curriculum Learning Guide</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Task Affinity Grouping</a></li>
<li class="toctree-l1"><a class="reference internal" href="mlflow_artifacts.html">MLflow Artifacts Guide</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/guide/task_affinity.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="task-affinity-grouping">
<h1>Task Affinity Grouping<a class="headerlink" href="#task-affinity-grouping" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id5">Overview</a></p>
<ul>
<li><p><a class="reference internal" href="#key-benefits" id="id6">Key Benefits</a></p></li>
<li><p><a class="reference internal" href="#algorithm-overview" id="id7">Algorithm Overview</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#inter-task-affinity-configuration-paper-accurate" id="id8">Inter-Task Affinity Configuration (Paper-Accurate)</a></p>
<ul>
<li><p><a class="reference internal" href="#mathematical-foundation" id="id9">Mathematical Foundation</a></p></li>
<li><p><a class="reference internal" href="#key-differences-from-legacy-approach" id="id10">Key Differences from Legacy Approach</a></p></li>
<li><p><a class="reference internal" href="#inter-task-affinity-parameters" id="id11">Inter-Task Affinity Parameters</a></p></li>
<li><p><a class="reference internal" href="#complete-inter-task-affinity-example" id="id12">Complete Inter-Task Affinity Example</a></p></li>
<li><p><a class="reference internal" href="#interpreting-inter-task-affinity-results" id="id13">Interpreting Inter-Task Affinity Results</a></p></li>
<li><p><a class="reference internal" href="#visualization" id="id14">Visualization</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#configuration-parameters" id="id15">Configuration Parameters</a></p>
<ul>
<li><p><a class="reference internal" href="#legacy-task-affinity-configuration-pre-training-approach" id="id16">Legacy Task Affinity Configuration (Pre-Training Approach)</a></p></li>
<li><p><a class="reference internal" href="#basic-parameters" id="id17">Basic Parameters</a></p></li>
<li><p><a class="reference internal" href="#affinity-computation-parameters" id="id18">Affinity Computation Parameters</a></p></li>
<li><p><a class="reference internal" href="#affinity-scoring-parameters" id="id19">Affinity Scoring Parameters</a></p></li>
<li><p><a class="reference internal" href="#clustering-parameters" id="id20">Clustering Parameters</a></p></li>
<li><p><a class="reference internal" href="#advanced-parameters" id="id21">Advanced Parameters</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#complete-configuration-example" id="id22">Complete Configuration Example</a></p>
<ul>
<li><p><a class="reference internal" href="#basic-configuration" id="id23">Basic Configuration</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id24">Production Configuration</a></p></li>
<li><p><a class="reference internal" href="#advanced-configuration" id="id25">Advanced Configuration</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#usage-examples" id="id26">Usage Examples</a></p>
<ul>
<li><p><a class="reference internal" href="#yaml-configuration-files" id="id27">YAML Configuration Files</a></p></li>
<li><p><a class="reference internal" href="#command-line-interface-examples" id="id28">Command Line Interface Examples</a></p></li>
<li><p><a class="reference internal" href="#python-api-examples" id="id29">Python API Examples</a></p></li>
<li><p><a class="reference internal" href="#analyzing-affinity-results" id="id30">Analyzing Affinity Results</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#practical-workflow" id="id31">Practical Workflow</a></p>
<ul>
<li><p><a class="reference internal" href="#step-by-step-guide-to-using-task-affinity" id="id32">Step-by-Step Guide to Using Task Affinity</a></p></li>
<li><p><a class="reference internal" href="#decision-making-guide" id="id33">Decision Making Guide</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#common-configurations" id="id34">Common Configurations</a></p>
<ul>
<li><p><a class="reference internal" href="#small-admet-panel-5-tasks" id="id35">Small ADMET Panel (5 tasks)</a></p></li>
<li><p><a class="reference internal" href="#standard-admet-panel-8-tasks" id="id36">Standard ADMET Panel (8 tasks)</a></p></li>
<li><p><a class="reference internal" href="#extended-admet-panel-15-tasks" id="id37">Extended ADMET Panel (15+ tasks)</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#performance-considerations" id="id38">Performance Considerations</a></p>
<ul>
<li><p><a class="reference internal" href="#computational-cost" id="id39">Computational Cost</a></p></li>
<li><p><a class="reference internal" href="#memory-usage" id="id40">Memory Usage</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id41">When to Use Task Affinity</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#troubleshooting" id="id42">Troubleshooting</a></p>
<ul>
<li><p><a class="reference internal" href="#common-issues" id="id43">Common Issues</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#best-practices" id="id44">Best Practices</a></p></li>
<li><p><a class="reference internal" href="#references" id="id45">References</a></p></li>
<li><p><a class="reference internal" href="#api-reference" id="id46">API Reference</a></p></li>
</ul>
</nav>
<section id="overview">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Overview</a><a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>Task Affinity Grouping (TAG) is an algorithm for efficiently identifying which tasks benefit from being trained together in multi-task learning. The method, introduced in <a class="reference external" href="https://arxiv.org/abs/2109.04617">Fifty et al. (NeurIPS 2021)</a>, computes gradient-based affinity scores between tasks and uses these to cluster tasks into groups.</p>
<section id="key-benefits">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Key Benefits</a><a class="headerlink" href="#key-benefits" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Improved Performance</strong>: Groups tasks that positively influence each other</p></li>
<li><p><strong>Efficiency</strong>: Uses a short training run to compute affinities</p></li>
<li><p><strong>Scalability</strong>: Works with large numbers of tasks</p></li>
<li><p><strong>Interpretability</strong>: Provides quantitative affinity scores between tasks</p></li>
</ul>
</section>
<section id="algorithm-overview">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Algorithm Overview</a><a class="headerlink" href="#algorithm-overview" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p><strong>Affinity Computation</strong>: Run a short joint training phase and compute per-task gradients with respect to shared encoder parameters</p></li>
<li><p><strong>Affinity Scoring</strong>: Measure cosine similarity between gradient vectors to quantify task affinity</p></li>
<li><p><strong>Task Clustering</strong>: Group tasks using hierarchical or spectral clustering</p></li>
<li><p><strong>Multi-Head Training</strong>: Train a single model with separate prediction heads for each task group</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There are two implementations of task affinity in this codebase:</p>
<ol class="arabic simple">
<li><p><strong>Inter-Task Affinity (Recommended)</strong>: Paper-accurate implementation using the lookahead
loss ratio method from Fifty et al. (2021). This computes affinity <em>during training</em> by
measuring how each task’s gradient update affects other tasks’ losses. See
<a class="reference internal" href="#inter-task-affinity-config"><span class="std std-ref">Inter-Task Affinity Configuration (Paper-Accurate)</span></a> below.</p></li>
<li><p><strong>Task Affinity (Legacy)</strong>: Pre-training approach using gradient cosine similarity.
This runs a separate affinity computation phase before training. See
<a class="reference internal" href="#legacy-task-affinity-config"><span class="std std-ref">Configuration Parameters</span></a> below.</p></li>
</ol>
<p>We recommend using the <strong>Inter-Task Affinity</strong> approach for new projects.</p>
</div>
</section>
</section>
<section id="inter-task-affinity-configuration-paper-accurate">
<span id="inter-task-affinity-config"></span><h2><a class="toc-backref" href="#id8" role="doc-backlink">Inter-Task Affinity Configuration (Paper-Accurate)</a><a class="headerlink" href="#inter-task-affinity-configuration-paper-accurate" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">InterTaskAffinityConfig</span></code> class implements the lookahead-based inter-task affinity
computation exactly as described in the TAG paper. This is the recommended approach for
measuring task relationships.</p>
<section id="mathematical-foundation">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Mathematical Foundation</a><a class="headerlink" href="#mathematical-foundation" title="Link to this heading">¶</a></h3>
<p>The inter-task affinity is computed using the following formula from Fifty et al. (2021):</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[Z^t_{ij} = 1 - \frac{L_j(X^t, \theta^{t+1}_{s|i}, \theta^t_j)}{L_j(X^t, \theta^t_s, \theta^t_j)}\]</div>
</div>
<p>Where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\theta^t_s\)</span>: Shared encoder parameters at training step <span class="math notranslate nohighlight">\(t\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\theta^{t+1}_{s|i} = \theta^t_s - \eta \nabla_{\theta_s} L_i\)</span>: Updated shared parameters after task <span class="math notranslate nohighlight">\(i\)</span>’s gradient step</p></li>
<li><p><span class="math notranslate nohighlight">\(L_j\)</span>: Loss function for task <span class="math notranslate nohighlight">\(j\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(X^t\)</span>: Input batch at step <span class="math notranslate nohighlight">\(t\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\eta\)</span>: Learning rate</p></li>
</ul>
<p><strong>Interpretation</strong>:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(Z^t_{ij} &gt; 0\)</span>: Task <span class="math notranslate nohighlight">\(i\)</span>’s update <strong>helps</strong> task <span class="math notranslate nohighlight">\(j\)</span> (positive transfer)</p></li>
<li><p><span class="math notranslate nohighlight">\(Z^t_{ij} &lt; 0\)</span>: Task <span class="math notranslate nohighlight">\(i\)</span>’s update <strong>hurts</strong> task <span class="math notranslate nohighlight">\(j\)</span> (negative transfer)</p></li>
<li><p><span class="math notranslate nohighlight">\(Z^t_{ij} \approx 0\)</span>: Task <span class="math notranslate nohighlight">\(i\)</span>’s update has <strong>minimal effect</strong> on task <span class="math notranslate nohighlight">\(j\)</span></p></li>
</ul>
<p>The training-level affinity matrix is the average over all steps:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\hat{Z}_{ij} = \frac{1}{T} \sum_{t=1}^{T} Z^t_{ij}\]</div>
</div>
</section>
<section id="key-differences-from-legacy-approach">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Key Differences from Legacy Approach</a><a class="headerlink" href="#key-differences-from-legacy-approach" title="Link to this heading">¶</a></h3>
<div class="table-wrapper colwidths-given docutils container" id="id4">
<table class="docutils align-default" id="id4">
<caption><span class="caption-text">Comparison of Affinity Approaches</span><a class="headerlink" href="#id4" title="Link to this table">¶</a></caption>
<colgroup>
<col style="width: 25.0%" />
<col style="width: 37.0%" />
<col style="width: 38.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Feature</p></th>
<th class="head"><p>Inter-Task Affinity (Recommended)</p></th>
<th class="head"><p>Legacy Task Affinity</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Computation</p></td>
<td><p>During training (per-step)</p></td>
<td><p>Separate pre-training phase</p></td>
</tr>
<tr class="row-odd"><td><p>Formula</p></td>
<td><p>Lookahead loss ratio</p></td>
<td><p>Gradient cosine similarity</p></td>
</tr>
<tr class="row-even"><td><p>Asymmetric</p></td>
<td><p>Yes (<span class="math notranslate nohighlight">\(Z_{ij} \neq Z_{ji}\)</span>)</p></td>
<td><p>No (symmetric)</p></td>
</tr>
<tr class="row-odd"><td><p>Measures</p></td>
<td><p>Effect of i’s update on j’s loss</p></td>
<td><p>Gradient direction similarity</p></td>
</tr>
<tr class="row-even"><td><p>Paper Reference</p></td>
<td><p>Fifty et al. (2021) Eq. 1</p></td>
<td><p>Inspired by TAG but simplified</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="inter-task-affinity-parameters">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">Inter-Task Affinity Parameters</a><a class="headerlink" href="#inter-task-affinity-parameters" title="Link to this heading">¶</a></h3>
<section id="enabled">
<h4>enabled<a class="headerlink" href="#enabled" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">bool</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">False</span></code></p>
</dd>
<dt class="field-odd">Description<span class="colon">:</span></dt>
<dd class="field-odd"><p>Whether to enable inter-task affinity computation during training.
When enabled, affinity is computed at specified step intervals.</p>
</dd>
<dt class="field-even">Example<span class="colon">:</span></dt>
<dd class="field-even"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">inter_task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
<section id="compute-every-n-steps">
<h4>compute_every_n_steps<a class="headerlink" href="#compute-every-n-steps" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">int</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">1</span></code></p>
</dd>
<dt class="field-odd">Description<span class="colon">:</span></dt>
<dd class="field-odd"><p>Compute affinity every N training steps. Setting this to 1 computes
affinity at every step (as in the paper). Higher values reduce
computational overhead but provide less granular measurements.</p>
</dd>
<dt class="field-even">Guidance<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">1</span></code>: Full per-step computation (recommended for analysis)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">5-10</span></code>: Good balance for training with monitoring</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">50-100</span></code>: Minimal overhead for production training</p></li>
</ul>
</dd>
<dt class="field-odd">Example<span class="colon">:</span></dt>
<dd class="field-odd"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">inter_task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">compute_every_n_steps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</pre></div>
</div>
</section>
<section id="log-every-n-steps">
<h4>log_every_n_steps<a class="headerlink" href="#log-every-n-steps" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">int</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">100</span></code></p>
</dd>
<dt class="field-odd">Description<span class="colon">:</span></dt>
<dd class="field-odd"><p>Log running average affinity metrics to MLflow every N steps.
Individual step matrices can be very noisy, so we aggregate them.</p>
</dd>
<dt class="field-even">Example<span class="colon">:</span></dt>
<dd class="field-even"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">inter_task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">log_every_n_steps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
</pre></div>
</div>
</section>
<section id="log-epoch-summary">
<h4>log_epoch_summary<a class="headerlink" href="#log-epoch-summary" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">bool</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">True</span></code></p>
</dd>
<dt class="field-odd">Description<span class="colon">:</span></dt>
<dd class="field-odd"><p>Log epoch-level summary statistics (mean, std, per-task-pair values).
Useful for monitoring affinity evolution during training.</p>
</dd>
<dt class="field-even">Example<span class="colon">:</span></dt>
<dd class="field-even"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">inter_task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">log_epoch_summary</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
<section id="log-step-matrices">
<h4>log_step_matrices<a class="headerlink" href="#log-step-matrices" title="Link to this heading">¶</a></h4>
<dl class="field-list">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">bool</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">False</span></code></p>
</dd>
<dt class="field-odd">Description<span class="colon">:</span></dt>
<dd class="field-odd"><p>Log individual step affinity matrices to MLflow.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This can generate a very large number of metrics.
Only enable for debugging or detailed analysis.</p>
</div>
</dd>
<dt class="field-even">Example<span class="colon">:</span></dt>
<dd class="field-even"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">inter_task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">log_step_matrices</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">  </span><span class="c1"># Keep off unless debugging</span>
</pre></div>
</div>
</section>
<section id="lookahead-lr">
<h4>lookahead_lr<a class="headerlink" href="#lookahead-lr" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">float</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">0.001</span></code></p>
</dd>
<dt class="field-odd">Description<span class="colon">:</span></dt>
<dd class="field-odd"><p>Learning rate <span class="math notranslate nohighlight">\(\eta\)</span> for computing the lookahead parameter update.
This controls the step size in the lookahead computation:
<span class="math notranslate nohighlight">\(\theta^{t+1}_{s|i} = \theta^t_s - \eta \nabla_{\theta_s} L_i\)</span></p>
</dd>
<dt class="field-even">Guidance<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p>Should typically match the training learning rate</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">use_optimizer_lr=True</span></code>, this value is overridden</p></li>
</ul>
</dd>
<dt class="field-odd">Example<span class="colon">:</span></dt>
<dd class="field-odd"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">inter_task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">lookahead_lr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.001</span>
</pre></div>
</div>
</section>
<section id="use-optimizer-lr">
<h4>use_optimizer_lr<a class="headerlink" href="#use-optimizer-lr" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">bool</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">True</span></code></p>
</dd>
<dt class="field-odd">Description<span class="colon">:</span></dt>
<dd class="field-odd"><p>If True, uses the current optimizer learning rate for lookahead
computation. This ensures the lookahead matches actual training dynamics.
Overrides <code class="docutils literal notranslate"><span class="pre">lookahead_lr</span></code> when enabled.</p>
</dd>
<dt class="field-even">Guidance<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>Recommended</strong>: <code class="docutils literal notranslate"><span class="pre">True</span></code> for most cases</p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">False</span></code> only if you want a fixed lookahead learning rate</p></li>
</ul>
</dd>
<dt class="field-odd">Example<span class="colon">:</span></dt>
<dd class="field-odd"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">inter_task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">use_optimizer_lr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
<section id="exclude-param-patterns">
<h4>exclude_param_patterns<a class="headerlink" href="#exclude-param-patterns" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">List[str]</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">[&quot;predictor&quot;,</span> <span class="pre">&quot;ffn&quot;,</span> <span class="pre">&quot;output&quot;,</span> <span class="pre">&quot;head&quot;,</span> <span class="pre">&quot;readout&quot;]</span></code></p>
</dd>
<dt class="field-odd">Description<span class="colon">:</span></dt>
<dd class="field-odd"><p>Patterns to identify task-specific parameters that should be excluded
from shared parameter computation. Parameters matching these patterns
are not included in the gradient computation for affinity.</p>
</dd>
<dt class="field-even">Default Exclusions<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">predictor</span></code>: Task prediction layers</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ffn</span></code>: Feed-forward network layers</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">output</span></code>: Output projection layers</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">head</span></code>: Task-specific heads</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">readout</span></code>: Readout/aggregation layers</p></li>
</ul>
</dd>
<dt class="field-odd">Example<span class="colon">:</span></dt>
<dd class="field-odd"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">inter_task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">exclude_param_patterns</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">predictor</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ffn</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">head</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">readout</span>
</pre></div>
</div>
</section>
<section id="log-to-mlflow">
<h4>log_to_mlflow<a class="headerlink" href="#log-to-mlflow" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">bool</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">True</span></code></p>
</dd>
<dt class="field-odd">Description<span class="colon">:</span></dt>
<dd class="field-odd"><p>Whether to log affinity metrics to MLflow. Logs include:</p>
<ul class="simple">
<li><p>Per-step running averages</p></li>
<li><p>Epoch summaries</p></li>
<li><p>Final affinity matrix as artifact</p></li>
</ul>
</dd>
<dt class="field-even">Example<span class="colon">:</span></dt>
<dd class="field-even"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">inter_task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">log_to_mlflow</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
</section>
<section id="complete-inter-task-affinity-example">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">Complete Inter-Task Affinity Example</a><a class="headerlink" href="#complete-inter-task-affinity-example" title="Link to this heading">¶</a></h3>
<section id="production-configuration">
<h4>Production Configuration<a class="headerlink" href="#production-configuration" title="Link to this heading">¶</a></h4>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Enable paper-accurate inter-task affinity during training</span>
<span class="nt">inter_task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">compute_every_n_steps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">  </span><span class="nt">log_every_n_steps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="w">  </span><span class="nt">log_epoch_summary</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">log_step_matrices</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">lookahead_lr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.001</span>
<span class="w">  </span><span class="nt">use_optimizer_lr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">exclude_param_patterns</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">predictor</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ffn</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">head</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">readout</span>
<span class="w">  </span><span class="nt">log_to_mlflow</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
<section id="analysis-configuration">
<h4>Analysis Configuration<a class="headerlink" href="#analysis-configuration" title="Link to this heading">¶</a></h4>
<p>For detailed affinity analysis (more overhead):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">inter_task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">compute_every_n_steps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w">        </span><span class="c1"># Every step for full analysis</span>
<span class="w">  </span><span class="nt">log_every_n_steps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span><span class="w">           </span><span class="c1"># Frequent logging</span>
<span class="w">  </span><span class="nt">log_epoch_summary</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">log_step_matrices</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">         </span><span class="c1"># Enable for debugging</span>
<span class="w">  </span><span class="nt">use_optimizer_lr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">log_to_mlflow</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
</section>
<section id="interpreting-inter-task-affinity-results">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">Interpreting Inter-Task Affinity Results</a><a class="headerlink" href="#interpreting-inter-task-affinity-results" title="Link to this heading">¶</a></h3>
<p>The affinity matrix is <strong>asymmetric</strong>. Entry <span class="math notranslate nohighlight">\(\hat{Z}_{ij}\)</span> represents:</p>
<ul class="simple">
<li><p><strong>The effect of task i on task j</strong></p></li>
<li><p>NOT the symmetric relationship between them</p></li>
</ul>
<p>Example interpretation:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Final affinity matrix (excerpt):
          LogD    KSOL    CLint
LogD      0.00    0.15   -0.08
KSOL      0.12    0.00    0.05
CLint    -0.05    0.08    0.00
</pre></div>
</div>
<ul class="simple">
<li><p>LogD → KSOL: 0.15 (LogD updates help KSOL)</p></li>
<li><p>KSOL → LogD: 0.12 (KSOL updates help LogD)</p></li>
<li><p>LogD → CLint: -0.08 (LogD updates slightly hurt CLint)</p></li>
<li><p>CLint → LogD: -0.05 (CLint updates slightly hurt LogD)</p></li>
</ul>
<p><strong>Task Grouping Strategy</strong>:</p>
<ol class="arabic simple">
<li><p>Group tasks with positive mutual affinity (LogD, KSOL)</p></li>
<li><p>Separate tasks with negative affinity from the group</p></li>
<li><p>Consider creating single-task models for isolated tasks</p></li>
</ol>
</section>
<section id="visualization">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Visualization</a><a class="headerlink" href="#visualization" title="Link to this heading">¶</a></h3>
<p>The repository includes utilities to visualize the affinity matrix and clustering.
For example, to plot a heatmap or clustermap:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">admet.model.chemprop.task_affinity</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
  <span class="n">compute_task_affinity</span><span class="p">,</span>
  <span class="n">plot_task_affinity_heatmap</span><span class="p">,</span>
  <span class="n">plot_task_affinity_clustermap</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">affinity</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">compute_task_affinity</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="s2">&quot;SMILES&quot;</span><span class="p">,</span> <span class="n">target_cols</span><span class="p">)</span>
<span class="c1"># Heatmap</span>
<span class="n">plot_task_affinity_heatmap</span><span class="p">(</span><span class="n">affinity</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="s2">&quot;affinity_heatmap.png&quot;</span><span class="p">)</span>

<span class="c1"># Clustermap with dendrogram and optional task-group colors</span>
<span class="n">plot_task_affinity_clustermap</span><span class="p">(</span><span class="n">affinity</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="s2">&quot;affinity_clustermap.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="configuration-parameters">
<span id="legacy-task-affinity-config"></span><h2><a class="toc-backref" href="#id15" role="doc-backlink">Configuration Parameters</a><a class="headerlink" href="#configuration-parameters" title="Link to this heading">¶</a></h2>
<section id="legacy-task-affinity-configuration-pre-training-approach">
<h3><a class="toc-backref" href="#id16" role="doc-backlink">Legacy Task Affinity Configuration (Pre-Training Approach)</a><a class="headerlink" href="#legacy-task-affinity-configuration-pre-training-approach" title="Link to this heading">¶</a></h3>
<div class="deprecated">
<p><span class="versionmodified deprecated">Deprecated since version 1.0: </span>The legacy <code class="docutils literal notranslate"><span class="pre">TaskAffinityConfig</span></code> uses gradient cosine similarity during a
separate pre-training phase. For paper-accurate implementation, use
<code class="docutils literal notranslate"><span class="pre">InterTaskAffinityConfig</span></code> instead (see <a class="reference internal" href="#inter-task-affinity-config"><span class="std std-ref">Inter-Task Affinity Configuration (Paper-Accurate)</span></a>).</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">TaskAffinityConfig</span></code> class controls all aspects of legacy task affinity
computation and grouping.</p>
</section>
<section id="basic-parameters">
<h3><a class="toc-backref" href="#id17" role="doc-backlink">Basic Parameters</a><a class="headerlink" href="#basic-parameters" title="Link to this heading">¶</a></h3>
<section id="id1">
<h4>enabled<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">bool</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">False</span></code></p>
</dd>
<dt class="field-odd">Description<span class="colon">:</span></dt>
<dd class="field-odd"><p>Whether to enable task affinity grouping. When <code class="docutils literal notranslate"><span class="pre">False</span></code>, standard multi-task learning is used.
When <code class="docutils literal notranslate"><span class="pre">True</span></code>, the algorithm computes task affinities and groups tasks before training.</p>
</dd>
<dt class="field-even">Example<span class="colon">:</span></dt>
<dd class="field-even"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
<section id="n-groups">
<h4>n_groups<a class="headerlink" href="#n-groups" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">int</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">3</span></code></p>
</dd>
<dt class="field-odd">Description<span class="colon">:</span></dt>
<dd class="field-odd"><p>Number of task groups to create via clustering. This controls how many separate prediction
heads will be created in the final model. Each group will have its own decoder head that
predicts all tasks in that group.</p>
</dd>
<dt class="field-even">Guidance<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p>Fewer groups: More sharing, potential for negative transfer</p></li>
<li><p>More groups: Less sharing, less potential for positive transfer</p></li>
<li><p>Typical range: 2-5 groups for 5-20 tasks</p></li>
<li><p>For N tasks, must have <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">≤</span> <span class="pre">n_groups</span> <span class="pre">≤</span> <span class="pre">N</span></code></p></li>
</ul>
</dd>
<dt class="field-odd">Example<span class="colon">:</span></dt>
<dd class="field-odd"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">n_groups</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span><span class="w">  </span><span class="c1"># Create 3 task groups</span>
</pre></div>
</div>
</section>
</section>
<section id="affinity-computation-parameters">
<h3><a class="toc-backref" href="#id18" role="doc-backlink">Affinity Computation Parameters</a><a class="headerlink" href="#affinity-computation-parameters" title="Link to this heading">¶</a></h3>
<section id="affinity-epochs">
<h4>affinity_epochs<a class="headerlink" href="#affinity-epochs" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">int</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">1</span></code></p>
</dd>
<dt class="field-odd">Description<span class="colon">:</span></dt>
<dd class="field-odd"><p>Number of epochs to run during the affinity computation phase. The algorithm performs a
short training run to observe gradient patterns. More epochs provide more stable gradient
statistics but increase computation time.</p>
</dd>
<dt class="field-even">Guidance<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p>Small datasets: 1-2 epochs usually sufficient</p></li>
<li><p>Large datasets: 1 epoch often enough</p></li>
<li><p>Noisy data: 2-3 epochs for more stable estimates</p></li>
<li><p>Each epoch computes gradients for all batches and accumulates affinity scores</p></li>
</ul>
</dd>
<dt class="field-odd">Example<span class="colon">:</span></dt>
<dd class="field-odd"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">affinity_epochs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</pre></div>
</div>
</section>
<section id="affinity-batch-size">
<h4>affinity_batch_size<a class="headerlink" href="#affinity-batch-size" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">int</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">64</span></code></p>
</dd>
<dt class="field-odd">Description<span class="colon">:</span></dt>
<dd class="field-odd"><p>Batch size used during affinity computation. Affects gradient variance and computation speed.
Larger batches provide more stable gradient estimates but use more memory.</p>
</dd>
<dt class="field-even">Guidance<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p>Small datasets: Use smaller batches (16-32)</p></li>
<li><p>Large datasets: Use larger batches (64-128)</p></li>
<li><p>Memory constraints: Reduce if running out of GPU memory</p></li>
<li><p>Trade-off: Larger batches = more stable but fewer gradient samples</p></li>
</ul>
</dd>
<dt class="field-odd">Example<span class="colon">:</span></dt>
<dd class="field-odd"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">affinity_batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">64</span>
</pre></div>
</div>
</section>
<section id="affinity-lr">
<h4>affinity_lr<a class="headerlink" href="#affinity-lr" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">float</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">1e-3</span></code> (0.001)</p>
</dd>
<dt class="field-odd">Description<span class="colon">:</span></dt>
<dd class="field-odd"><p>Learning rate used during the affinity computation phase. This controls how much the model
parameters change during the short training run. The goal is to compute meaningful gradients
without over-training.</p>
</dd>
<dt class="field-even">Guidance<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p>Standard value: <code class="docutils literal notranslate"><span class="pre">1e-3</span></code> works well in most cases</p></li>
<li><p>Unstable gradients: Try smaller values (<code class="docutils literal notranslate"><span class="pre">5e-4</span></code>, <code class="docutils literal notranslate"><span class="pre">1e-4</span></code>)</p></li>
<li><p>Very small models: May use slightly larger (<code class="docutils literal notranslate"><span class="pre">2e-3</span></code>)</p></li>
<li><p>The learning rate affects gradient magnitudes, but affinity uses normalized gradients</p></li>
</ul>
</dd>
<dt class="field-odd">Example<span class="colon">:</span></dt>
<dd class="field-odd"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">affinity_lr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.001</span>
</pre></div>
</div>
</section>
</section>
<section id="affinity-scoring-parameters">
<h3><a class="toc-backref" href="#id19" role="doc-backlink">Affinity Scoring Parameters</a><a class="headerlink" href="#affinity-scoring-parameters" title="Link to this heading">¶</a></h3>
<section id="affinity-type">
<h4>affinity_type<a class="headerlink" href="#affinity-type" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">str</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">&quot;cosine&quot;</span></code></p>
</dd>
<dt class="field-odd">Options<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">&quot;cosine&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;dot_product&quot;</span></code></p>
</dd>
<dt class="field-even">Description<span class="colon">:</span></dt>
<dd class="field-even"><p>Type of affinity measure to compute between task gradients.</p>
</dd>
<dt class="field-odd">Options<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;cosine&quot;</span></code>: Cosine similarity between gradient vectors (normalized dot product).
Range: [-1, 1]. Focuses on gradient direction rather than magnitude.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;dot_product&quot;</span></code>: Raw dot product between gradient vectors. Considers both direction
and magnitude. Automatically normalized to cosine-like values at the end.</p></li>
</ul>
</dd>
<dt class="field-even">Guidance<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>Recommended</strong>: <code class="docutils literal notranslate"><span class="pre">&quot;cosine&quot;</span></code> for most cases</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;cosine&quot;</span></code>: Better when tasks have different loss scales</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;dot_product&quot;</span></code>: May be useful when gradient magnitude is meaningful</p></li>
</ul>
</dd>
<dt class="field-odd">Example<span class="colon">:</span></dt>
<dd class="field-odd"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">affinity_type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cosine&quot;</span>
</pre></div>
</div>
</section>
<section id="normalize-gradients">
<h4>normalize_gradients<a class="headerlink" href="#normalize-gradients" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">bool</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">True</span></code></p>
</dd>
<dt class="field-odd">Description<span class="colon">:</span></dt>
<dd class="field-odd"><p>Whether to normalize gradient vectors before computing affinity. When <code class="docutils literal notranslate"><span class="pre">True</span></code>, each
gradient vector is normalized to unit length before computing dot products.</p>
</dd>
<dt class="field-even">Guidance<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>Recommended</strong>: <code class="docutils literal notranslate"><span class="pre">True</span></code> for most cases</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code>: Focuses on gradient direction, robust to different loss scales</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code>: Considers gradient magnitude, useful in special cases</p></li>
<li><p>Usually kept at <code class="docutils literal notranslate"><span class="pre">True</span></code> when <code class="docutils literal notranslate"><span class="pre">affinity_type=&quot;cosine&quot;</span></code></p></li>
</ul>
</dd>
<dt class="field-odd">Example<span class="colon">:</span></dt>
<dd class="field-odd"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">normalize_gradients</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
</section>
<section id="clustering-parameters">
<h3><a class="toc-backref" href="#id20" role="doc-backlink">Clustering Parameters</a><a class="headerlink" href="#clustering-parameters" title="Link to this heading">¶</a></h3>
<section id="clustering-method">
<h4>clustering_method<a class="headerlink" href="#clustering-method" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">str</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">&quot;agglomerative&quot;</span></code></p>
</dd>
<dt class="field-odd">Options<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">&quot;agglomerative&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;spectral&quot;</span></code></p>
</dd>
<dt class="field-even">Description<span class="colon">:</span></dt>
<dd class="field-even"><p>Clustering algorithm used to group tasks based on affinity scores.</p>
</dd>
<dt class="field-odd">Options<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;agglomerative&quot;</span></code>: Hierarchical agglomerative clustering. Builds a tree of task
relationships and cuts at the specified number of groups. More interpretable and
deterministic.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;spectral&quot;</span></code>: Spectral clustering using graph theory. Can find non-convex clusters
but requires more computation and is sensitive to parameters.</p></li>
</ul>
</dd>
<dt class="field-even">Guidance<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>Recommended</strong>: <code class="docutils literal notranslate"><span class="pre">&quot;agglomerative&quot;</span></code> for most cases</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;agglomerative&quot;</span></code>: Better for small-medium number of tasks (&lt; 50)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;spectral&quot;</span></code>: May help with complex affinity patterns</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;agglomerative&quot;</span></code>: More stable and reproducible</p></li>
</ul>
</dd>
<dt class="field-odd">Example<span class="colon">:</span></dt>
<dd class="field-odd"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">clustering_method</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;agglomerative&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="advanced-parameters">
<h3><a class="toc-backref" href="#id21" role="doc-backlink">Advanced Parameters</a><a class="headerlink" href="#advanced-parameters" title="Link to this heading">¶</a></h3>
<section id="encoder-param-patterns">
<h4>encoder_param_patterns<a class="headerlink" href="#encoder-param-patterns" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">List[str]</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">[]</span></code> (uses default exclusion patterns)</p>
</dd>
<dt class="field-odd">Description<span class="colon">:</span></dt>
<dd class="field-odd"><p>List of string patterns to identify shared encoder parameters. Gradients are computed
only with respect to these parameters. If empty, uses default patterns that exclude
predictor/FFN/output layers.</p>
</dd>
<dt class="field-even">Default Exclusion Patterns<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;predictor&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;predict&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;ffn&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;output&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;readout&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;head&quot;</span></code></p></li>
</ul>
</dd>
<dt class="field-odd">Guidance<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>Recommended</strong>: Leave empty (<code class="docutils literal notranslate"><span class="pre">[]</span></code>) to use defaults</p></li>
<li><p>Custom patterns: Only specify if you have custom architecture</p></li>
<li><p>Parameters matching these patterns are <strong>included</strong> if list is non-empty</p></li>
<li><p>Parameters matching default exclusions are <strong>excluded</strong> if list is empty</p></li>
</ul>
</dd>
<dt class="field-even">Example<span class="colon">:</span></dt>
<dd class="field-even"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">encoder_param_patterns</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w">  </span><span class="c1"># Use defaults</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">encoder_param_patterns</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;encoder&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;mpnn&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;bond_message&quot;</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># Custom</span>
</pre></div>
</div>
</section>
<section id="device">
<h4>device<a class="headerlink" href="#device" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">str</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">&quot;auto&quot;</span></code></p>
</dd>
<dt class="field-odd">Options<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">&quot;auto&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;cpu&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;cuda&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;cuda:0&quot;</span></code>, etc.</p>
</dd>
<dt class="field-even">Description<span class="colon">:</span></dt>
<dd class="field-even"><p>Device for computation during affinity computation phase.</p>
</dd>
<dt class="field-odd">Options<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;auto&quot;</span></code>: Automatically selects CUDA if available, otherwise CPU</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;cpu&quot;</span></code>: Force CPU computation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;cuda&quot;</span></code>: Use default CUDA device</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;cuda:N&quot;</span></code>: Use specific CUDA device N</p></li>
</ul>
</dd>
<dt class="field-even">Guidance<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>Recommended</strong>: <code class="docutils literal notranslate"><span class="pre">&quot;auto&quot;</span></code> for most cases</p></li>
<li><p>GPU recommended for large models or datasets</p></li>
<li><p>CPU acceptable for small affinity computations (1-2 epochs)</p></li>
</ul>
</dd>
<dt class="field-odd">Example<span class="colon">:</span></dt>
<dd class="field-odd"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;auto&quot;</span>
</pre></div>
</div>
</section>
<section id="seed">
<h4>seed<a class="headerlink" href="#seed" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">int</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">42</span></code></p>
</dd>
<dt class="field-odd">Description<span class="colon">:</span></dt>
<dd class="field-odd"><p>Random seed for reproducibility. Affects data shuffling during affinity computation
and spectral clustering (if used).</p>
</dd>
<dt class="field-even">Guidance<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p>Use consistent seed for reproducible experiments</p></li>
<li><p>Different seeds may produce slightly different groupings</p></li>
<li><p>Affinity scores themselves are deterministic given the same data order</p></li>
</ul>
</dd>
<dt class="field-odd">Example<span class="colon">:</span></dt>
<dd class="field-odd"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cuda&quot;</span>
<span class="w">  </span><span class="nt">seed</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">42</span>
</pre></div>
</div>
</section>
<section id="log-affinity-matrix">
<h4>log_affinity_matrix<a class="headerlink" href="#log-affinity-matrix" title="Link to this heading">¶</a></h4>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">bool</span></code></p>
</dd>
<dt class="field-even">Default<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">True</span></code></p>
</dd>
<dt class="field-odd">Description<span class="colon">:</span></dt>
<dd class="field-odd"><p>Whether to log the computed affinity matrix to the console/log file. When <code class="docutils literal notranslate"><span class="pre">True</span></code>,
prints a formatted matrix showing affinity scores between all task pairs.</p>
</dd>
<dt class="field-even">Example Output<span class="colon">:</span></dt>
<dd class="field-even"><p></p></dd>
</dl>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Task affinity matrix computed:
  LogD: [1.000 0.872 0.234 -0.156]
  KSOL: [0.872 1.000 0.189 -0.201]
  PAMPA: [0.234 0.189 1.000 0.445]
  hERG: [-0.156 -0.201 0.445 1.000]
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Example<span class="colon">:</span></dt>
<dd class="field-odd"><p></p></dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">log_affinity_matrix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="complete-configuration-example">
<h2><a class="toc-backref" href="#id22" role="doc-backlink">Complete Configuration Example</a><a class="headerlink" href="#complete-configuration-example" title="Link to this heading">¶</a></h2>
<section id="basic-configuration">
<h3><a class="toc-backref" href="#id23" role="doc-backlink">Basic Configuration</a><a class="headerlink" href="#basic-configuration" title="Link to this heading">¶</a></h3>
<p>Minimal configuration to enable task affinity grouping:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">n_groups</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</pre></div>
</div>
</section>
<section id="id2">
<h3><a class="toc-backref" href="#id24" role="doc-backlink">Production Configuration</a><a class="headerlink" href="#id2" title="Link to this heading">¶</a></h3>
<p>Recommended configuration for production use:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># Core settings</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">n_groups</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>

<span class="w">  </span><span class="c1"># Affinity computation</span>
<span class="w">  </span><span class="nt">affinity_epochs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">affinity_batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">64</span>
<span class="w">  </span><span class="nt">affinity_lr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.001</span>

<span class="w">  </span><span class="c1"># Affinity scoring</span>
<span class="w">  </span><span class="nt">affinity_type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cosine&quot;</span>
<span class="w">  </span><span class="nt">normalize_gradients</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">  </span><span class="c1"># Clustering</span>
<span class="w">  </span><span class="nt">clustering_method</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;agglomerative&quot;</span>

<span class="w">  </span><span class="c1"># System</span>
<span class="w">  </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;auto&quot;</span>
<span class="w">  </span><span class="nt">seed</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">42</span>
<span class="w">  </span><span class="nt">log_affinity_matrix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
<section id="advanced-configuration">
<h3><a class="toc-backref" href="#id25" role="doc-backlink">Advanced Configuration</a><a class="headerlink" href="#advanced-configuration" title="Link to this heading">¶</a></h3>
<p>Configuration with all parameters explicitly set:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># Enable/disable</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">  </span><span class="c1"># Grouping</span>
<span class="w">  </span><span class="nt">n_groups</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>

<span class="w">  </span><span class="c1"># Affinity computation phase</span>
<span class="w">  </span><span class="nt">affinity_epochs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">  </span><span class="nt">affinity_batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32</span>
<span class="w">  </span><span class="nt">affinity_lr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0005</span>

<span class="w">  </span><span class="c1"># Affinity scoring</span>
<span class="w">  </span><span class="nt">affinity_type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cosine&quot;</span>
<span class="w">  </span><span class="nt">normalize_gradients</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">  </span><span class="c1"># Clustering</span>
<span class="w">  </span><span class="nt">clustering_method</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;agglomerative&quot;</span>

<span class="w">  </span><span class="c1"># Advanced</span>
<span class="w">  </span><span class="nt">encoder_param_patterns</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="w">  </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cuda:0&quot;</span>
<span class="w">  </span><span class="nt">seed</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">123</span>
<span class="w">  </span><span class="nt">log_affinity_matrix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
</section>
<section id="usage-examples">
<h2><a class="toc-backref" href="#id26" role="doc-backlink">Usage Examples</a><a class="headerlink" href="#usage-examples" title="Link to this heading">¶</a></h2>
<section id="yaml-configuration-files">
<h3><a class="toc-backref" href="#id27" role="doc-backlink">YAML Configuration Files</a><a class="headerlink" href="#yaml-configuration-files" title="Link to this heading">¶</a></h3>
<section id="basic-configuration-recommended-starting-point">
<h4>Basic Configuration (Recommended Starting Point)<a class="headerlink" href="#basic-configuration-recommended-starting-point" title="Link to this heading">¶</a></h4>
<p>Create <code class="docutils literal notranslate"><span class="pre">configs/task-affinity/chemprop_task_affinity.yaml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Basic Chemprop configuration with task affinity</span>
<span class="nt">model</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;chemprop&quot;</span>
<span class="w">  </span><span class="nt">message_passing</span><span class="p">:</span>
<span class="w">    </span><span class="nt">depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">    </span><span class="nt">hidden_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span>
<span class="w">  </span><span class="nt">ffn</span><span class="p">:</span>
<span class="w">    </span><span class="nt">num_layers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">    </span><span class="nt">hidden_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span>

<span class="c1"># Enable task affinity grouping</span>
<span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">n_groups</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">affinity_epochs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">affinity_batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">64</span>
<span class="w">  </span><span class="nt">log_affinity_matrix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="c1"># Training configuration</span>
<span class="nt">training</span><span class="p">:</span>
<span class="w">  </span><span class="nt">epochs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span>
<span class="w">  </span><span class="nt">batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">64</span>
<span class="w">  </span><span class="nt">learning_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.001</span>
<span class="w">  </span><span class="nt">warmup_epochs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>

<span class="c1"># Data configuration</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">smiles_column</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;SMILES&quot;</span>
<span class="w">  </span><span class="nt">target_columns</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;LogD&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KSOL&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;PAMPA&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;hERG&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;CLint&quot;</span>
<span class="w">  </span><span class="nt">split_type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;scaffold&quot;</span>
<span class="w">  </span><span class="nt">split_ratios</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.8</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.1</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
</section>
<section id="advanced-configuration-with-all-parameters">
<h4>Advanced Configuration with All Parameters<a class="headerlink" href="#advanced-configuration-with-all-parameters" title="Link to this heading">¶</a></h4>
<p>Create <code class="docutils literal notranslate"><span class="pre">configs/task-affinity/chemprop_task_affinity_advanced.yaml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Advanced Chemprop configuration with full task affinity settings</span>
<span class="nt">model</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;chemprop&quot;</span>
<span class="w">  </span><span class="nt">message_passing</span><span class="p">:</span>
<span class="w">    </span><span class="nt">depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<span class="w">    </span><span class="nt">hidden_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">400</span>
<span class="w">    </span><span class="nt">dropout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.1</span>
<span class="w">  </span><span class="nt">ffn</span><span class="p">:</span>
<span class="w">    </span><span class="nt">num_layers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">    </span><span class="nt">hidden_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">400</span>
<span class="w">    </span><span class="nt">dropout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.1</span>

<span class="c1"># Full task affinity configuration</span>
<span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># Enable/disable</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">  </span><span class="c1"># Grouping parameters</span>
<span class="w">  </span><span class="nt">n_groups</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<span class="w">  </span><span class="nt">clustering_method</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;agglomerative&quot;</span><span class="w">  </span><span class="c1"># or &quot;spectral&quot;</span>

<span class="w">  </span><span class="c1"># Affinity computation phase</span>
<span class="w">  </span><span class="nt">affinity_epochs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">  </span><span class="nt">affinity_batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32</span>
<span class="w">  </span><span class="nt">affinity_lr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0005</span>

<span class="w">  </span><span class="c1"># Affinity scoring</span>
<span class="w">  </span><span class="nt">affinity_type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cosine&quot;</span><span class="w">  </span><span class="c1"># or &quot;dot_product&quot;</span>
<span class="w">  </span><span class="nt">normalize_gradients</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">  </span><span class="c1"># Advanced settings</span>
<span class="w">  </span><span class="nt">encoder_param_patterns</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w">  </span><span class="c1"># Use default exclusion patterns</span>
<span class="w">  </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cuda&quot;</span>
<span class="w">  </span><span class="nt">seed</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">42</span>
<span class="w">  </span><span class="nt">log_affinity_matrix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="c1"># Training configuration</span>
<span class="nt">training</span><span class="p">:</span>
<span class="w">  </span><span class="nt">epochs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="w">  </span><span class="nt">batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">64</span>
<span class="w">  </span><span class="nt">learning_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.001</span>
<span class="w">  </span><span class="nt">warmup_epochs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">  </span><span class="nt">max_lr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.001</span>
<span class="w">  </span><span class="nt">final_lr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0001</span>

<span class="c1"># Data configuration</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">smiles_column</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;SMILES&quot;</span>
<span class="w">  </span><span class="nt">target_columns</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;LogD&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KSOL&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;PAMPA&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;Papp&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;hERG&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;CYP3A4&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;CLint&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;CLhep&quot;</span>
<span class="w">  </span><span class="nt">split_type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;scaffold&quot;</span>
<span class="w">  </span><span class="nt">split_ratios</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.8</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.1</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
</section>
<section id="exploratory-configuration-finding-optimal-groups">
<h4>Exploratory Configuration (Finding Optimal Groups)<a class="headerlink" href="#exploratory-configuration-finding-optimal-groups" title="Link to this heading">¶</a></h4>
<p>Create <code class="docutils literal notranslate"><span class="pre">configs/task-affinity/chemprop_task_affinity_explore.yaml</span></code> to try different group numbers:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Configuration for exploring different task groupings</span>
<span class="nt">model</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;chemprop&quot;</span>
<span class="w">  </span><span class="nt">message_passing</span><span class="p">:</span>
<span class="w">    </span><span class="nt">depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">    </span><span class="nt">hidden_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span>
<span class="w">  </span><span class="nt">ffn</span><span class="p">:</span>
<span class="w">    </span><span class="nt">num_layers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">    </span><span class="nt">hidden_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span>

<span class="c1"># Task affinity for exploration</span>
<span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">n_groups</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w">  </span><span class="c1"># Try 2, 3, 4, 5 in separate runs</span>
<span class="w">  </span><span class="nt">affinity_epochs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w">  </span><span class="c1"># More epochs for stable estimates</span>
<span class="w">  </span><span class="nt">affinity_batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">64</span>
<span class="w">  </span><span class="nt">affinity_type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cosine&quot;</span>
<span class="w">  </span><span class="nt">clustering_method</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;agglomerative&quot;</span>
<span class="w">  </span><span class="nt">log_affinity_matrix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># Critical for analysis</span>

<span class="c1"># Shorter training for quick experiments</span>
<span class="nt">training</span><span class="p">:</span>
<span class="w">  </span><span class="nt">epochs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<span class="w">  </span><span class="nt">batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">64</span>
<span class="w">  </span><span class="nt">learning_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.001</span>

<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">smiles_column</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;SMILES&quot;</span>
<span class="w">  </span><span class="nt">target_columns</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;LogD&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KSOL&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;PAMPA&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;hERG&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;CLint&quot;</span>
<span class="w">  </span><span class="nt">split_type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;scaffold&quot;</span>
<span class="w">  </span><span class="nt">split_ratios</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.8</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.1</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
</section>
</section>
<section id="command-line-interface-examples">
<h3><a class="toc-backref" href="#id28" role="doc-backlink">Command Line Interface Examples</a><a class="headerlink" href="#command-line-interface-examples" title="Link to this heading">¶</a></h3>
<section id="basic-usage-with-yaml-config">
<h4>Basic Usage with YAML Config<a class="headerlink" href="#basic-usage-with-yaml-config" title="Link to this heading">¶</a></h4>
<p>Train a model with task affinity enabled:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Using a config file</span>
python<span class="w"> </span>-m<span class="w"> </span>admet.cli.train<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--config<span class="w"> </span>configs/task-affinity/chemprop_task_affinity.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data-path<span class="w"> </span>data/admet_train.csv<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--save-dir<span class="w"> </span>models/chemprop_task_affinity
</pre></div>
</div>
</section>
<section id="override-config-with-cli-arguments">
<h4>Override Config with CLI Arguments<a class="headerlink" href="#override-config-with-cli-arguments" title="Link to this heading">¶</a></h4>
<p>Start with a base config and override specific parameters:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Override task affinity parameters via CLI</span>
python<span class="w"> </span>-m<span class="w"> </span>admet.cli.train<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--config<span class="w"> </span>configs/0-experiment/chemprop.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.enabled<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.n-groups<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.affinity-epochs<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.clustering-method<span class="w"> </span>agglomerative<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data-path<span class="w"> </span>data/admet_train.csv<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--save-dir<span class="w"> </span>models/chemprop_affinity_3groups
</pre></div>
</div>
</section>
<section id="experiment-with-different-group-numbers">
<h4>Experiment with Different Group Numbers<a class="headerlink" href="#experiment-with-different-group-numbers" title="Link to this heading">¶</a></h4>
<p>Run multiple experiments to find optimal grouping:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Try 2 groups</span>
python<span class="w"> </span>-m<span class="w"> </span>admet.cli.train<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--config<span class="w"> </span>configs/task-affinity/chemprop_task_affinity.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.n-groups<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--save-dir<span class="w"> </span>models/affinity_2groups

<span class="c1"># Try 3 groups</span>
python<span class="w"> </span>-m<span class="w"> </span>admet.cli.train<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--config<span class="w"> </span>configs/task-affinity/chemprop_task_affinity.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.n-groups<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--save-dir<span class="w"> </span>models/affinity_3groups

<span class="c1"># Try 4 groups</span>
python<span class="w"> </span>-m<span class="w"> </span>admet.cli.train<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--config<span class="w"> </span>configs/task-affinity/chemprop_task_affinity.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.n-groups<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--save-dir<span class="w"> </span>models/affinity_4groups

<span class="c1"># Try 5 groups</span>
python<span class="w"> </span>-m<span class="w"> </span>admet.cli.train<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--config<span class="w"> </span>configs/task-affinity/chemprop_task_affinity.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.n-groups<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--save-dir<span class="w"> </span>models/affinity_5groups
</pre></div>
</div>
</section>
<section id="compare-clustering-methods">
<h4>Compare Clustering Methods<a class="headerlink" href="#compare-clustering-methods" title="Link to this heading">¶</a></h4>
<p>Test different clustering algorithms:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Agglomerative clustering (hierarchical)</span>
python<span class="w"> </span>-m<span class="w"> </span>admet.cli.train<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--config<span class="w"> </span>configs/task-affinity/chemprop_task_affinity.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.clustering-method<span class="w"> </span>agglomerative<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--save-dir<span class="w"> </span>models/affinity_agglomerative

<span class="c1"># Spectral clustering (graph-based)</span>
python<span class="w"> </span>-m<span class="w"> </span>admet.cli.train<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--config<span class="w"> </span>configs/task-affinity/chemprop_task_affinity.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.clustering-method<span class="w"> </span>spectral<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--save-dir<span class="w"> </span>models/affinity_spectral
</pre></div>
</div>
</section>
<section id="compute-affinity-matrix-only">
<h4>Compute Affinity Matrix Only<a class="headerlink" href="#compute-affinity-matrix-only" title="Link to this heading">¶</a></h4>
<p>Compute and save the affinity matrix without full training:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Quick affinity computation (1 epoch)</span>
python<span class="w"> </span>-m<span class="w"> </span>admet.cli.compute_task_affinity<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data-path<span class="w"> </span>data/admet_train.csv<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--smiles-column<span class="w"> </span>SMILES<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--target-columns<span class="w"> </span>LogD<span class="w"> </span>KSOL<span class="w"> </span>PAMPA<span class="w"> </span>hERG<span class="w"> </span>CLint<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--affinity-epochs<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--affinity-batch-size<span class="w"> </span><span class="m">64</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--save-path<span class="w"> </span>results/task_affinity.npz<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--plot-heatmap<span class="w"> </span>results/task_affinity_heatmap.png
</pre></div>
</div>
</section>
<section id="production-training-with-optimized-groups">
<h4>Production Training with Optimized Groups<a class="headerlink" href="#production-training-with-optimized-groups" title="Link to this heading">¶</a></h4>
<p>After determining optimal grouping, train production model:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Production training with task affinity</span>
python<span class="w"> </span>-m<span class="w"> </span>admet.cli.train<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--config<span class="w"> </span>configs/task-affinity/chemprop_task_affinity.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.enabled<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.n-groups<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.affinity-epochs<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data-path<span class="w"> </span>data/admet_full_train.csv<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--save-dir<span class="w"> </span>models/production/chemprop_affinity<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--seed<span class="w"> </span><span class="m">42</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--training.epochs<span class="w"> </span><span class="m">100</span>
</pre></div>
</div>
</section>
</section>
<section id="python-api-examples">
<h3><a class="toc-backref" href="#id29" role="doc-backlink">Python API Examples</a><a class="headerlink" href="#python-api-examples" title="Link to this heading">¶</a></h3>
<p>Using the configuration class directly:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">admet.model.chemprop.task_affinity</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">TaskAffinityConfig</span><span class="p">,</span>
    <span class="n">compute_task_affinity</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="c1"># Load data</span>
<span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/admet_train.csv&quot;</span><span class="p">)</span>
<span class="n">target_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;LogD&quot;</span><span class="p">,</span> <span class="s2">&quot;KSOL&quot;</span><span class="p">,</span> <span class="s2">&quot;PAMPA&quot;</span><span class="p">,</span> <span class="s2">&quot;hERG&quot;</span><span class="p">,</span> <span class="s2">&quot;CLint&quot;</span><span class="p">]</span>

<span class="c1"># Configure task affinity</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">TaskAffinityConfig</span><span class="p">(</span>
    <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">n_groups</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">affinity_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">affinity_batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Compute affinity and groups</span>
<span class="n">affinity_matrix</span><span class="p">,</span> <span class="n">task_names</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">compute_task_affinity</span><span class="p">(</span>
    <span class="n">df_train</span><span class="o">=</span><span class="n">df_train</span><span class="p">,</span>
    <span class="n">smiles_col</span><span class="o">=</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span>
    <span class="n">target_cols</span><span class="o">=</span><span class="n">target_cols</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Task groups:&quot;</span><span class="p">,</span> <span class="n">groups</span><span class="p">)</span>
<span class="c1"># Output: [[&#39;LogD&#39;, &#39;KSOL&#39;], [&#39;PAMPA&#39;, &#39;hERG&#39;], [&#39;CLint&#39;]]</span>
</pre></div>
</div>
<section id="complete-workflow-compute-visualize-and-train">
<h4>Complete Workflow: Compute, Visualize, and Train<a class="headerlink" href="#complete-workflow-compute-visualize-and-train" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">admet.model.chemprop.task_affinity</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">TaskAffinityConfig</span><span class="p">,</span>
    <span class="n">compute_task_affinity</span><span class="p">,</span>
    <span class="n">plot_task_affinity_heatmap</span><span class="p">,</span>
    <span class="n">affinity_matrix_to_dataframe</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="c1"># Load training data</span>
<span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/admet_train.csv&quot;</span><span class="p">)</span>
<span class="n">target_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;LogD&quot;</span><span class="p">,</span> <span class="s2">&quot;KSOL&quot;</span><span class="p">,</span> <span class="s2">&quot;PAMPA&quot;</span><span class="p">,</span> <span class="s2">&quot;hERG&quot;</span><span class="p">,</span> <span class="s2">&quot;CLint&quot;</span><span class="p">,</span> <span class="s2">&quot;CYP3A4&quot;</span><span class="p">]</span>

<span class="c1"># Step 1: Compute task affinity</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">TaskAffinityConfig</span><span class="p">(</span>
    <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">n_groups</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">affinity_epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">affinity_batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
    <span class="n">affinity_type</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span><span class="p">,</span>
    <span class="n">clustering_method</span><span class="o">=</span><span class="s2">&quot;agglomerative&quot;</span><span class="p">,</span>
    <span class="n">log_affinity_matrix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">affinity_matrix</span><span class="p">,</span> <span class="n">task_names</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">compute_task_affinity</span><span class="p">(</span>
    <span class="n">df_train</span><span class="o">=</span><span class="n">df_train</span><span class="p">,</span>
    <span class="n">smiles_col</span><span class="o">=</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span>
    <span class="n">target_cols</span><span class="o">=</span><span class="n">target_cols</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Step 2: Save affinity matrix</span>
<span class="n">df_affinity</span> <span class="o">=</span> <span class="n">affinity_matrix_to_dataframe</span><span class="p">(</span><span class="n">affinity_matrix</span><span class="p">,</span> <span class="n">task_names</span><span class="p">)</span>
<span class="n">df_affinity</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;results/task_affinity_matrix.csv&quot;</span><span class="p">)</span>

<span class="c1"># Step 3: Visualize affinity</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plot_task_affinity_heatmap</span><span class="p">(</span>
    <span class="n">affinity_matrix</span><span class="p">,</span>
    <span class="n">task_names</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ADMET Task Affinity Matrix&quot;</span><span class="p">,</span>
    <span class="n">save_path</span><span class="o">=</span><span class="s2">&quot;results/task_affinity_heatmap.png&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Step 4: Print groups</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Task Groups Formed:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Group </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Step 5: Train model with these groups</span>
<span class="c1"># (use groups in your training pipeline)</span>
</pre></div>
</div>
</section>
<section id="exploring-different-numbers-of-groups">
<h4>Exploring Different Numbers of Groups<a class="headerlink" href="#exploring-different-numbers-of-groups" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">admet.model.chemprop.task_affinity</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">TaskAffinityConfig</span><span class="p">,</span>
    <span class="n">TaskAffinityComputer</span><span class="p">,</span>
    <span class="n">TaskGrouper</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Load data</span>
<span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/admet_train.csv&quot;</span><span class="p">)</span>
<span class="n">target_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;LogD&quot;</span><span class="p">,</span> <span class="s2">&quot;KSOL&quot;</span><span class="p">,</span> <span class="s2">&quot;PAMPA&quot;</span><span class="p">,</span> <span class="s2">&quot;hERG&quot;</span><span class="p">,</span> <span class="s2">&quot;CLint&quot;</span><span class="p">]</span>

<span class="c1"># Compute affinity once</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">TaskAffinityConfig</span><span class="p">(</span><span class="n">affinity_epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">affinity_batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
<span class="n">computer</span> <span class="o">=</span> <span class="n">TaskAffinityComputer</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">affinity_matrix</span><span class="p">,</span> <span class="n">task_names</span> <span class="o">=</span> <span class="n">computer</span><span class="o">.</span><span class="n">compute_from_dataframe</span><span class="p">(</span>
    <span class="n">df_train</span><span class="p">,</span> <span class="s2">&quot;SMILES&quot;</span><span class="p">,</span> <span class="n">target_cols</span>
<span class="p">)</span>

<span class="c1"># Try different numbers of groups</span>
<span class="k">for</span> <span class="n">n_groups</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>
    <span class="n">grouper</span> <span class="o">=</span> <span class="n">TaskGrouper</span><span class="p">(</span><span class="n">n_groups</span><span class="o">=</span><span class="n">n_groups</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;agglomerative&quot;</span><span class="p">)</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">grouper</span><span class="o">.</span><span class="n">cluster</span><span class="p">(</span><span class="n">affinity_matrix</span><span class="p">,</span> <span class="n">task_names</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">n_groups</span><span class="si">}</span><span class="s2"> Groups:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Group </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="analyzing-affinity-results">
<h3><a class="toc-backref" href="#id30" role="doc-backlink">Analyzing Affinity Results</a><a class="headerlink" href="#analyzing-affinity-results" title="Link to this heading">¶</a></h3>
<section id="extracting-and-examining-the-affinity-matrix">
<h4>Extracting and Examining the Affinity Matrix<a class="headerlink" href="#extracting-and-examining-the-affinity-matrix" title="Link to this heading">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run training with affinity computation</span>
python<span class="w"> </span>-m<span class="w"> </span>admet.cli.train<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--config<span class="w"> </span>configs/task-affinity/chemprop_task_affinity.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data-path<span class="w"> </span>data/admet_train.csv<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--save-dir<span class="w"> </span>models/affinity_analysis<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.log-affinity-matrix<span class="w"> </span><span class="nb">true</span>

<span class="c1"># The affinity matrix will be logged to console like:</span>
<span class="c1"># Task affinity matrix computed:</span>
<span class="c1">#   LogD: [1.000 0.872 0.234 -0.156 0.089]</span>
<span class="c1">#   KSOL: [0.872 1.000 0.189 -0.201 0.045]</span>
<span class="c1">#   PAMPA: [0.234 0.189 1.000 0.445 0.123]</span>
<span class="c1">#   hERG: [-0.156 -0.201 0.445 1.000 0.567]</span>
<span class="c1">#   CLint: [0.089 0.045 0.123 0.567 1.000]</span>
</pre></div>
</div>
</section>
<section id="reading-the-affinity-matrix">
<h4>Reading the Affinity Matrix<a class="headerlink" href="#reading-the-affinity-matrix" title="Link to this heading">¶</a></h4>
<p>From the example above:</p>
<ul class="simple">
<li><p><strong>LogD ↔ KSOL (0.872)</strong>: Very high positive affinity → should be grouped together</p></li>
<li><p><strong>hERG ↔ CLint (0.567)</strong>: Moderate positive affinity → can benefit from grouping</p></li>
<li><p><strong>PAMPA ↔ hERG (0.445)</strong>: Moderate affinity → borderline case</p></li>
<li><p><strong>LogD ↔ hERG (-0.156)</strong>: Negative affinity → should be in separate groups</p></li>
<li><p><strong>LogD ↔ PAMPA (0.234)</strong>: Weak positive affinity → may or may not group</p></li>
</ul>
<p>Expected groupings for n_groups=3:</p>
<ul class="simple">
<li><p>Group 0: [LogD, KSOL] (solubility properties)</p></li>
<li><p>Group 1: [PAMPA, hERG, CLint] (permeability/clearance)</p></li>
<li><p>Or alternative based on dendrogram structure</p></li>
</ul>
</section>
<section id="visualizing-affinity-with-heatmaps">
<h4>Visualizing Affinity with Heatmaps<a class="headerlink" href="#visualizing-affinity-with-heatmaps" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">admet.model.chemprop.task_affinity</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">compute_task_affinity</span><span class="p">,</span>
    <span class="n">plot_task_affinity_heatmap</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="c1"># Compute affinity</span>
<span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/admet_train.csv&quot;</span><span class="p">)</span>
<span class="n">target_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;LogD&quot;</span><span class="p">,</span> <span class="s2">&quot;KSOL&quot;</span><span class="p">,</span> <span class="s2">&quot;PAMPA&quot;</span><span class="p">,</span> <span class="s2">&quot;hERG&quot;</span><span class="p">,</span> <span class="s2">&quot;CLint&quot;</span><span class="p">]</span>

<span class="n">affinity_matrix</span><span class="p">,</span> <span class="n">task_names</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">compute_task_affinity</span><span class="p">(</span>
    <span class="n">df_train</span><span class="p">,</span>
    <span class="n">smiles_col</span><span class="o">=</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span>
    <span class="n">target_cols</span><span class="o">=</span><span class="n">target_cols</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Create heatmap</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plot_task_affinity_heatmap</span><span class="p">(</span>
    <span class="n">affinity_matrix</span><span class="p">,</span>
    <span class="n">task_names</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ADMET Task Affinity Matrix&quot;</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;RdBu_r&quot;</span><span class="p">,</span>  <span class="c1"># Red for negative, blue for positive</span>
    <span class="n">save_path</span><span class="o">=</span><span class="s2">&quot;results/task_affinity_heatmap.png&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="batch-processing-multiple-datasets">
<h4>Batch Processing Multiple Datasets<a class="headerlink" href="#batch-processing-multiple-datasets" title="Link to this heading">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># Script: analyze_task_affinities.sh</span>
<span class="c1"># Compute affinities for multiple datasets</span>

<span class="nv">datasets</span><span class="o">=(</span><span class="s2">&quot;admet_small&quot;</span><span class="w"> </span><span class="s2">&quot;admet_large&quot;</span><span class="w"> </span><span class="s2">&quot;admet_diverse&quot;</span><span class="o">)</span>

<span class="k">for</span><span class="w"> </span>dataset<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">datasets</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Analyzing dataset: </span><span class="nv">$dataset</span><span class="s2">&quot;</span>

<span class="w">    </span>python<span class="w"> </span>-m<span class="w"> </span>admet.cli.compute_task_affinity<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--data-path<span class="w"> </span><span class="s2">&quot;data/</span><span class="si">${</span><span class="nv">dataset</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--smiles-column<span class="w"> </span>SMILES<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--target-columns<span class="w"> </span>LogD<span class="w"> </span>KSOL<span class="w"> </span>PAMPA<span class="w"> </span>hERG<span class="w"> </span>CLint<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--affinity-epochs<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--affinity-batch-size<span class="w"> </span><span class="m">64</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--save-path<span class="w"> </span><span class="s2">&quot;results/</span><span class="si">${</span><span class="nv">dataset</span><span class="si">}</span><span class="s2">_affinity.npz&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--plot-heatmap<span class="w"> </span><span class="s2">&quot;results/</span><span class="si">${</span><span class="nv">dataset</span><span class="si">}</span><span class="s2">_affinity.png&quot;</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Results saved to results/</span><span class="si">${</span><span class="nv">dataset</span><span class="si">}</span><span class="s2">_affinity.*&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;---&quot;</span>
<span class="k">done</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="practical-workflow">
<h2><a class="toc-backref" href="#id31" role="doc-backlink">Practical Workflow</a><a class="headerlink" href="#practical-workflow" title="Link to this heading">¶</a></h2>
<section id="step-by-step-guide-to-using-task-affinity">
<h3><a class="toc-backref" href="#id32" role="doc-backlink">Step-by-Step Guide to Using Task Affinity</a><a class="headerlink" href="#step-by-step-guide-to-using-task-affinity" title="Link to this heading">¶</a></h3>
<section id="step-1-initial-affinity-computation">
<h4>Step 1: Initial Affinity Computation<a class="headerlink" href="#step-1-initial-affinity-computation" title="Link to this heading">¶</a></h4>
<p>Start by computing the affinity matrix to understand task relationships:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute affinity matrix with visualization</span>
python<span class="w"> </span>-m<span class="w"> </span>admet.cli.compute_task_affinity<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data-path<span class="w"> </span>data/admet_train.csv<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--smiles-column<span class="w"> </span>SMILES<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--target-columns<span class="w"> </span>LogD<span class="w"> </span>KSOL<span class="w"> </span>PAMPA<span class="w"> </span>Papp<span class="w"> </span>hERG<span class="w"> </span>CYP3A4<span class="w"> </span>CLint<span class="w"> </span>CLhep<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--affinity-epochs<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--affinity-batch-size<span class="w"> </span><span class="m">64</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--clustering-method<span class="w"> </span>agglomerative<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--save-path<span class="w"> </span>results/initial_affinity.npz<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--plot-heatmap<span class="w"> </span>results/initial_affinity_heatmap.png
</pre></div>
</div>
<p><strong>What to look for:</strong></p>
<ul class="simple">
<li><p>Strong positive affinities (&gt; 0.6) indicate tasks that should be grouped</p></li>
<li><p>Negative affinities (&lt; -0.2) indicate tasks that interfere</p></li>
<li><p>Review the heatmap for natural clustering patterns</p></li>
</ul>
</section>
<section id="step-2-determine-optimal-number-of-groups">
<h4>Step 2: Determine Optimal Number of Groups<a class="headerlink" href="#step-2-determine-optimal-number-of-groups" title="Link to this heading">¶</a></h4>
<p>Run quick experiments with different group numbers:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create experiment script</span>
cat<span class="w"> </span>&gt;<span class="w"> </span>scripts/find_optimal_groups.sh<span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39;</span>
<span class="s">#!/bin/bash</span>

<span class="s">for n_groups in 2 3 4 5; do</span>
<span class="s">    echo &quot;Training with $n_groups groups...&quot;</span>

<span class="s">    python -m admet.cli.train \</span>
<span class="s">      --config configs/task-affinity/chemprop_task_affinity.yaml \</span>
<span class="s">      --data-path data/admet_train.csv \</span>
<span class="s">      --task-affinity.n-groups $n_groups \</span>
<span class="s">      --training.epochs 30 \</span>
<span class="s">      --save-dir models/group_search/n${n_groups} \</span>
<span class="s">      --seed 42</span>

<span class="s">    echo &quot;Evaluating model with $n_groups groups...&quot;</span>
<span class="s">    python -m admet.cli.evaluate \</span>
<span class="s">      --model-dir models/group_search/n${n_groups} \</span>
<span class="s">      --data-path data/admet_test.csv \</span>
<span class="s">      --output results/eval_n${n_groups}.json</span>
<span class="s">done</span>

<span class="s"># Compare results</span>
<span class="s">python -m admet.cli.compare_models \</span>
<span class="s">  --result-files results/eval_n*.json \</span>
<span class="s">  --output results/group_comparison.csv</span>
<span class="s">EOF</span>

chmod<span class="w"> </span>+x<span class="w"> </span>scripts/find_optimal_groups.sh
bash<span class="w"> </span>scripts/find_optimal_groups.sh
</pre></div>
</div>
<p><strong>Decision criteria:</strong></p>
<ul class="simple">
<li><p>Compare validation metrics across different n_groups</p></li>
<li><p>Check for overfitting (train vs. val performance)</p></li>
<li><p>Consider model complexity vs. performance gain</p></li>
<li><p>Ensure groups make scientific sense</p></li>
</ul>
</section>
<section id="step-3-train-production-model">
<h4>Step 3: Train Production Model<a class="headerlink" href="#step-3-train-production-model" title="Link to this heading">¶</a></h4>
<p>Once optimal grouping is determined, train the final model:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Train production model with optimal grouping (e.g., 3 groups)</span>
python<span class="w"> </span>-m<span class="w"> </span>admet.cli.train<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--config<span class="w"> </span>configs/3-production/chemprop_task_affinity.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data-path<span class="w"> </span>data/admet_full_train.csv<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.enabled<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.n-groups<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.affinity-epochs<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.affinity-batch-size<span class="w"> </span><span class="m">64</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--training.epochs<span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--save-dir<span class="w"> </span>models/production/chemprop_affinity_v1<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--seed<span class="w"> </span><span class="m">42</span>
</pre></div>
</div>
</section>
<section id="step-4-compare-against-baselines">
<h4>Step 4: Compare Against Baselines<a class="headerlink" href="#step-4-compare-against-baselines" title="Link to this heading">¶</a></h4>
<p>Compare task affinity model against standard approaches:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Single-task baseline</span>
python<span class="w"> </span>-m<span class="w"> </span>admet.cli.train<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--config<span class="w"> </span>configs/0-experiment/chemprop.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data-path<span class="w"> </span>data/admet_train.csv<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--save-dir<span class="w"> </span>models/baseline/single_task

<span class="c1"># Standard multi-task (no affinity)</span>
python<span class="w"> </span>-m<span class="w"> </span>admet.cli.train<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--config<span class="w"> </span>configs/0-experiment/chemprop.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data-path<span class="w"> </span>data/admet_train.csv<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.enabled<span class="w"> </span><span class="nb">false</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--save-dir<span class="w"> </span>models/baseline/multi_task

<span class="c1"># Task affinity multi-task</span>
python<span class="w"> </span>-m<span class="w"> </span>admet.cli.train<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--config<span class="w"> </span>configs/task-affinity/chemprop_task_affinity.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data-path<span class="w"> </span>data/admet_train.csv<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.enabled<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--task-affinity.n-groups<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--save-dir<span class="w"> </span>models/affinity/multi_head

<span class="c1"># Compare all three</span>
python<span class="w"> </span>-m<span class="w"> </span>admet.cli.compare_models<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--model-dirs<span class="w"> </span>models/baseline/single_task<span class="w"> </span><span class="se">\</span>
<span class="w">                </span>models/baseline/multi_task<span class="w"> </span><span class="se">\</span>
<span class="w">                </span>models/affinity/multi_head<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--test-data<span class="w"> </span>data/admet_test.csv<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--output<span class="w"> </span>results/final_comparison.csv
</pre></div>
</div>
</section>
</section>
<section id="decision-making-guide">
<h3><a class="toc-backref" href="#id33" role="doc-backlink">Decision Making Guide</a><a class="headerlink" href="#decision-making-guide" title="Link to this heading">¶</a></h3>
<section id="when-to-use-task-affinity">
<h4>When to Use Task Affinity<a class="headerlink" href="#when-to-use-task-affinity" title="Link to this heading">¶</a></h4>
<p>✅ <strong>Use task affinity when:</strong></p>
<ul class="simple">
<li><p>You have 5-20 diverse prediction tasks</p></li>
<li><p>Tasks span different ADMET categories (e.g., solubility, permeability, toxicity)</p></li>
<li><p>Standard multi-task learning shows negative transfer</p></li>
<li><p>You suspect some tasks help each other, but not all</p></li>
<li><p>You have moderate amounts of data per task (100-1000+ samples)</p></li>
</ul>
<p>❌ <strong>Skip task affinity when:</strong></p>
<ul class="simple">
<li><p>You have &lt; 5 tasks (manually group or use standard multi-task)</p></li>
<li><p>All tasks are very similar (e.g., all solubility at different pH)</p></li>
<li><p>You have extremely limited data (&lt; 100 samples total)</p></li>
<li><p>Computational resources are severely constrained</p></li>
<li><p>You need the absolute simplest model</p></li>
</ul>
</section>
<section id="how-to-choose-number-of-groups">
<h4>How to Choose Number of Groups<a class="headerlink" href="#how-to-choose-number-of-groups" title="Link to this heading">¶</a></h4>
<p><strong>Rule of thumb:</strong></p>
<ul class="simple">
<li><p><strong>2 groups</strong>: Clear dichotomy in tasks (e.g., physicochemical vs. biological)</p></li>
<li><p><strong>3 groups</strong>: Most common choice for mixed ADMET tasks</p></li>
<li><p><strong>4-5 groups</strong>: Many heterogeneous tasks with complex relationships</p></li>
<li><p><strong>N groups</strong> (where N = num_tasks): Equivalent to single-task learning</p></li>
</ul>
<p><strong>Empirical approach:</strong></p>
<ol class="arabic simple">
<li><p>Start with <code class="docutils literal notranslate"><span class="pre">n_groups</span> <span class="pre">=</span> <span class="pre">ceil(num_tasks</span> <span class="pre">/</span> <span class="pre">2.5)</span></code></p></li>
<li><p>Try ±1 around this value</p></li>
<li><p>Select based on validation performance</p></li>
<li><p>Verify groups make scientific sense</p></li>
</ol>
<p><strong>Example decisions:</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>5 tasks → Try 2-3 groups
8 tasks → Try 3-4 groups
12 tasks → Try 4-5 groups
20 tasks → Try 6-8 groups
</pre></div>
</div>
</section>
<section id="interpreting-affinity-values">
<h4>Interpreting Affinity Values<a class="headerlink" href="#interpreting-affinity-values" title="Link to this heading">¶</a></h4>
<p><strong>Strong positive affinity (0.7 - 1.0):</strong></p>
<ul class="simple">
<li><p>Tasks should definitely be grouped together</p></li>
<li><p>Likely share similar molecular features</p></li>
<li><p>Example: LogD and KSOL (both solubility-related)</p></li>
</ul>
<p><strong>Moderate positive affinity (0.3 - 0.7):</strong></p>
<ul class="simple">
<li><p>Tasks may benefit from grouping</p></li>
<li><p>Shared features but also unique aspects</p></li>
<li><p>Example: PAMPA and Caco-2 (both permeability)</p></li>
</ul>
<p><strong>Weak affinity (-0.3 - 0.3):</strong></p>
<ul class="simple">
<li><p>Tasks are largely independent</p></li>
<li><p>Can group or separate based on other criteria</p></li>
<li><p>Example: Solubility and metabolic stability</p></li>
</ul>
<p><strong>Negative affinity (&lt; -0.3):</strong></p>
<ul class="simple">
<li><p>Tasks interfere with each other</p></li>
<li><p>Should be in separate groups</p></li>
<li><p>Example: Sometimes physicochemical vs. complex biological endpoints</p></li>
</ul>
</section>
</section>
</section>
<section id="common-configurations">
<h2><a class="toc-backref" href="#id34" role="doc-backlink">Common Configurations</a><a class="headerlink" href="#common-configurations" title="Link to this heading">¶</a></h2>
<section id="small-admet-panel-5-tasks">
<h3><a class="toc-backref" href="#id35" role="doc-backlink">Small ADMET Panel (5 tasks)</a><a class="headerlink" href="#small-admet-panel-5-tasks" title="Link to this heading">¶</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># configs/admet_small_affinity.yaml</span>
<span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">n_groups</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">  </span><span class="nt">affinity_epochs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">affinity_batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">64</span>
<span class="w">  </span><span class="nt">clustering_method</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;agglomerative&quot;</span>

<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">target_columns</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;LogD&quot;</span><span class="w">      </span><span class="c1"># Physicochemical</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KSOL&quot;</span><span class="w">      </span><span class="c1"># Physicochemical</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;PAMPA&quot;</span><span class="w">     </span><span class="c1"># Permeability</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;hERG&quot;</span><span class="w">      </span><span class="c1"># Safety</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;CLint&quot;</span><span class="w">     </span><span class="c1"># Metabolism</span>
</pre></div>
</div>
</section>
<section id="standard-admet-panel-8-tasks">
<h3><a class="toc-backref" href="#id36" role="doc-backlink">Standard ADMET Panel (8 tasks)</a><a class="headerlink" href="#standard-admet-panel-8-tasks" title="Link to this heading">¶</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># configs/admet_standard_affinity.yaml</span>
<span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">n_groups</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">affinity_epochs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">affinity_batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">64</span>
<span class="w">  </span><span class="nt">clustering_method</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;agglomerative&quot;</span>

<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">target_columns</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;LogD&quot;</span><span class="w">      </span><span class="c1"># Physicochemical</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KSOL&quot;</span><span class="w">      </span><span class="c1"># Physicochemical</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;PAMPA&quot;</span><span class="w">     </span><span class="c1"># Permeability</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;Papp&quot;</span><span class="w">      </span><span class="c1"># Permeability</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;hERG&quot;</span><span class="w">      </span><span class="c1"># Safety</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;CYP3A4&quot;</span><span class="w">    </span><span class="c1"># Metabolism</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;CLint&quot;</span><span class="w">     </span><span class="c1"># Metabolism</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;CLhep&quot;</span><span class="w">     </span><span class="c1"># Metabolism</span>
</pre></div>
</div>
</section>
<section id="extended-admet-panel-15-tasks">
<h3><a class="toc-backref" href="#id37" role="doc-backlink">Extended ADMET Panel (15+ tasks)</a><a class="headerlink" href="#extended-admet-panel-15-tasks" title="Link to this heading">¶</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># configs/admet_extended_affinity.yaml</span>
<span class="nt">task_affinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">n_groups</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">  </span><span class="nt">affinity_epochs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">  </span><span class="nt">affinity_batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32</span>
<span class="w">  </span><span class="nt">clustering_method</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;agglomerative&quot;</span>
<span class="w">  </span><span class="nt">affinity_type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cosine&quot;</span>

<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">target_columns</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># Physicochemical (likely Group 0)</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;LogD&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KSOL&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;pKa&quot;</span>

<span class="w">    </span><span class="c1"># Permeability (likely Group 1)</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;PAMPA&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;Papp&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;Caco2&quot;</span>

<span class="w">    </span><span class="c1"># Safety (likely Group 2)</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;hERG&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;AMES&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;Hepatotox&quot;</span>

<span class="w">    </span><span class="c1"># Phase I Metabolism (likely Group 3)</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;CYP1A2&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;CYP2C9&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;CYP2D6&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;CYP3A4&quot;</span>

<span class="w">    </span><span class="c1"># Clearance (likely Group 4)</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;CLint&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;CLhep&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;Thalf&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="performance-considerations">
<h2><a class="toc-backref" href="#id38" role="doc-backlink">Performance Considerations</a><a class="headerlink" href="#performance-considerations" title="Link to this heading">¶</a></h2>
<section id="computational-cost">
<h3><a class="toc-backref" href="#id39" role="doc-backlink">Computational Cost</a><a class="headerlink" href="#computational-cost" title="Link to this heading">¶</a></h3>
<p>Task affinity computation adds overhead:</p>
<ul class="simple">
<li><p><strong>Affinity phase</strong>: 1-2 epochs of training (quick)</p></li>
<li><p><strong>Clustering</strong>: Negligible for &lt; 50 tasks</p></li>
<li><p><strong>Total overhead</strong>: Typically &lt; 5% of total training time</p></li>
</ul>
</section>
<section id="memory-usage">
<h3><a class="toc-backref" href="#id40" role="doc-backlink">Memory Usage</a><a class="headerlink" href="#memory-usage" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Similar to regular training during affinity computation</p></li>
<li><p>Slightly higher memory for gradient computation</p></li>
<li><p>Use smaller <code class="docutils literal notranslate"><span class="pre">affinity_batch_size</span></code> if memory-constrained</p></li>
</ul>
</section>
<section id="id3">
<h3><a class="toc-backref" href="#id41" role="doc-backlink">When to Use Task Affinity</a><a class="headerlink" href="#id3" title="Link to this heading">¶</a></h3>
<p><strong>Recommended for:</strong></p>
<ul class="simple">
<li><p>5+ tasks with varying properties</p></li>
<li><p>Heterogeneous task types (e.g., mixed ADMET properties)</p></li>
<li><p>When negative transfer is suspected</p></li>
<li><p>Limited data per task</p></li>
</ul>
<p><strong>May skip for:</strong></p>
<ul class="simple">
<li><p>&lt; 5 tasks (manual grouping easier)</p></li>
<li><p>Very homogeneous tasks (e.g., all solubility measurements)</p></li>
<li><p>Extremely large task sets (&gt; 100 tasks, use approximate methods)</p></li>
</ul>
</section>
</section>
<section id="troubleshooting">
<h2><a class="toc-backref" href="#id42" role="doc-backlink">Troubleshooting</a><a class="headerlink" href="#troubleshooting" title="Link to this heading">¶</a></h2>
<section id="common-issues">
<h3><a class="toc-backref" href="#id43" role="doc-backlink">Common Issues</a><a class="headerlink" href="#common-issues" title="Link to this heading">¶</a></h3>
<section id="no-gradient-steps">
<h4>No Gradient Steps<a class="headerlink" href="#no-gradient-steps" title="Link to this heading">¶</a></h4>
<p><strong>Error</strong>: <code class="docutils literal notranslate"><span class="pre">RuntimeError:</span> <span class="pre">No</span> <span class="pre">gradient</span> <span class="pre">steps</span> <span class="pre">were</span> <span class="pre">performed</span></code></p>
<p><strong>Causes</strong>:</p>
<ul class="simple">
<li><p>All target values are NaN</p></li>
<li><p>Batch size larger than dataset</p></li>
<li><p>Invalid SMILES strings</p></li>
</ul>
<p><strong>Solutions</strong>:</p>
<ul class="simple">
<li><p>Check data for missing values</p></li>
<li><p>Reduce <code class="docutils literal notranslate"><span class="pre">affinity_batch_size</span></code></p></li>
<li><p>Validate SMILES with canonicalization</p></li>
</ul>
</section>
<section id="unstable-affinity-scores">
<h4>Unstable Affinity Scores<a class="headerlink" href="#unstable-affinity-scores" title="Link to this heading">¶</a></h4>
<p><strong>Symptom</strong>: Affinity matrix has extreme values or NaNs</p>
<p><strong>Solutions</strong>:</p>
<ul class="simple">
<li><p>Increase <code class="docutils literal notranslate"><span class="pre">affinity_epochs</span></code> for more stable estimates</p></li>
<li><p>Check for very imbalanced target distributions</p></li>
<li><p>Normalize target values before training</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">affinity_type=&quot;cosine&quot;</span></code> for robustness</p></li>
</ul>
</section>
<section id="poor-groupings">
<h4>Poor Groupings<a class="headerlink" href="#poor-groupings" title="Link to this heading">¶</a></h4>
<p><strong>Symptom</strong>: Clustering produces unintuitive groups</p>
<p><strong>Solutions</strong>:</p>
<ul class="simple">
<li><p>Try different <code class="docutils literal notranslate"><span class="pre">n_groups</span></code> values</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">clustering_method=&quot;spectral&quot;</span></code> for non-convex clusters</p></li>
<li><p>Manually inspect affinity matrix for patterns</p></li>
<li><p>Consider increasing <code class="docutils literal notranslate"><span class="pre">affinity_epochs</span></code></p></li>
</ul>
</section>
</section>
</section>
<section id="best-practices">
<h2><a class="toc-backref" href="#id44" role="doc-backlink">Best Practices</a><a class="headerlink" href="#best-practices" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p><strong>Start Simple</strong>: Begin with <code class="docutils literal notranslate"><span class="pre">n_groups=3</span></code> and default parameters</p></li>
<li><p><strong>Inspect Matrix</strong>: Always log and visualize the affinity matrix</p></li>
<li><p><strong>Validate Groups</strong>: Check that groups make scientific sense</p></li>
<li><p><strong>Tune Carefully</strong>: Only adjust parameters if default results are poor</p></li>
<li><p><strong>Compare Baselines</strong>: Compare against standard multi-task and single-task models</p></li>
<li><p><strong>Cross-Validate</strong>: Use consistent grouping across CV folds</p></li>
</ol>
</section>
<section id="references">
<h2><a class="toc-backref" href="#id45" role="doc-backlink">References</a><a class="headerlink" href="#references" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>Fifty, C., Amid, E., Zhao, Z., Yu, T., Anil, R., &amp; Finn, C. (2021).
<strong>Efficiently Identifying Task Groupings for Multi-Task Learning</strong>.
<em>Advances in Neural Information Processing Systems</em>, 34.
<a class="reference external" href="https://arxiv.org/abs/2109.04617">arXiv:2109.04617</a></p></li>
<li><p>Implementation inspired by Google Research TAG:
<a class="reference external" href="https://github.com/google-research/google-research/tree/master/tag">https://github.com/google-research/google-research/tree/master/tag</a></p></li>
</ul>
</section>
<section id="api-reference">
<h2><a class="toc-backref" href="#id46" role="doc-backlink">API Reference</a><a class="headerlink" href="#api-reference" title="Link to this heading">¶</a></h2>
<p>For detailed API documentation, see:</p>
<p><strong>Inter-Task Affinity (Recommended)</strong>:</p>
<ul class="simple">
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">admet.model.chemprop.inter_task_affinity.InterTaskAffinityConfig</span></code></p></li>
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">admet.model.chemprop.inter_task_affinity.InterTaskAffinityComputer</span></code></p></li>
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">admet.model.chemprop.inter_task_affinity.InterTaskAffinityCallback</span></code></p></li>
</ul>
<p><strong>Legacy Task Affinity (Deprecated)</strong>:</p>
<ul class="simple">
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">admet.model.chemprop.task_affinity.TaskAffinityConfig</span></code></p></li>
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">admet.model.chemprop.task_affinity.TaskAffinityComputer</span></code></p></li>
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">admet.model.chemprop.task_affinity.TaskGrouper</span></code></p></li>
<li><p><code class="xref py py-func docutils literal notranslate"><span class="pre">admet.model.chemprop.task_affinity.compute_task_affinity()</span></code></p></li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="mlflow_artifacts.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">MLflow Artifacts Guide</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="curriculum.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Curriculum Learning Guide</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Alec Glisman, Ph.D.
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Task Affinity Grouping</a><ul>
<li><a class="reference internal" href="#overview">Overview</a><ul>
<li><a class="reference internal" href="#key-benefits">Key Benefits</a></li>
<li><a class="reference internal" href="#algorithm-overview">Algorithm Overview</a></li>
</ul>
</li>
<li><a class="reference internal" href="#inter-task-affinity-configuration-paper-accurate">Inter-Task Affinity Configuration (Paper-Accurate)</a><ul>
<li><a class="reference internal" href="#mathematical-foundation">Mathematical Foundation</a></li>
<li><a class="reference internal" href="#key-differences-from-legacy-approach">Key Differences from Legacy Approach</a></li>
<li><a class="reference internal" href="#inter-task-affinity-parameters">Inter-Task Affinity Parameters</a><ul>
<li><a class="reference internal" href="#enabled">enabled</a></li>
<li><a class="reference internal" href="#compute-every-n-steps">compute_every_n_steps</a></li>
<li><a class="reference internal" href="#log-every-n-steps">log_every_n_steps</a></li>
<li><a class="reference internal" href="#log-epoch-summary">log_epoch_summary</a></li>
<li><a class="reference internal" href="#log-step-matrices">log_step_matrices</a></li>
<li><a class="reference internal" href="#lookahead-lr">lookahead_lr</a></li>
<li><a class="reference internal" href="#use-optimizer-lr">use_optimizer_lr</a></li>
<li><a class="reference internal" href="#exclude-param-patterns">exclude_param_patterns</a></li>
<li><a class="reference internal" href="#log-to-mlflow">log_to_mlflow</a></li>
</ul>
</li>
<li><a class="reference internal" href="#complete-inter-task-affinity-example">Complete Inter-Task Affinity Example</a><ul>
<li><a class="reference internal" href="#production-configuration">Production Configuration</a></li>
<li><a class="reference internal" href="#analysis-configuration">Analysis Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#interpreting-inter-task-affinity-results">Interpreting Inter-Task Affinity Results</a></li>
<li><a class="reference internal" href="#visualization">Visualization</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuration-parameters">Configuration Parameters</a><ul>
<li><a class="reference internal" href="#legacy-task-affinity-configuration-pre-training-approach">Legacy Task Affinity Configuration (Pre-Training Approach)</a></li>
<li><a class="reference internal" href="#basic-parameters">Basic Parameters</a><ul>
<li><a class="reference internal" href="#id1">enabled</a></li>
<li><a class="reference internal" href="#n-groups">n_groups</a></li>
</ul>
</li>
<li><a class="reference internal" href="#affinity-computation-parameters">Affinity Computation Parameters</a><ul>
<li><a class="reference internal" href="#affinity-epochs">affinity_epochs</a></li>
<li><a class="reference internal" href="#affinity-batch-size">affinity_batch_size</a></li>
<li><a class="reference internal" href="#affinity-lr">affinity_lr</a></li>
</ul>
</li>
<li><a class="reference internal" href="#affinity-scoring-parameters">Affinity Scoring Parameters</a><ul>
<li><a class="reference internal" href="#affinity-type">affinity_type</a></li>
<li><a class="reference internal" href="#normalize-gradients">normalize_gradients</a></li>
</ul>
</li>
<li><a class="reference internal" href="#clustering-parameters">Clustering Parameters</a><ul>
<li><a class="reference internal" href="#clustering-method">clustering_method</a></li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-parameters">Advanced Parameters</a><ul>
<li><a class="reference internal" href="#encoder-param-patterns">encoder_param_patterns</a></li>
<li><a class="reference internal" href="#device">device</a></li>
<li><a class="reference internal" href="#seed">seed</a></li>
<li><a class="reference internal" href="#log-affinity-matrix">log_affinity_matrix</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#complete-configuration-example">Complete Configuration Example</a><ul>
<li><a class="reference internal" href="#basic-configuration">Basic Configuration</a></li>
<li><a class="reference internal" href="#id2">Production Configuration</a></li>
<li><a class="reference internal" href="#advanced-configuration">Advanced Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#usage-examples">Usage Examples</a><ul>
<li><a class="reference internal" href="#yaml-configuration-files">YAML Configuration Files</a><ul>
<li><a class="reference internal" href="#basic-configuration-recommended-starting-point">Basic Configuration (Recommended Starting Point)</a></li>
<li><a class="reference internal" href="#advanced-configuration-with-all-parameters">Advanced Configuration with All Parameters</a></li>
<li><a class="reference internal" href="#exploratory-configuration-finding-optimal-groups">Exploratory Configuration (Finding Optimal Groups)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#command-line-interface-examples">Command Line Interface Examples</a><ul>
<li><a class="reference internal" href="#basic-usage-with-yaml-config">Basic Usage with YAML Config</a></li>
<li><a class="reference internal" href="#override-config-with-cli-arguments">Override Config with CLI Arguments</a></li>
<li><a class="reference internal" href="#experiment-with-different-group-numbers">Experiment with Different Group Numbers</a></li>
<li><a class="reference internal" href="#compare-clustering-methods">Compare Clustering Methods</a></li>
<li><a class="reference internal" href="#compute-affinity-matrix-only">Compute Affinity Matrix Only</a></li>
<li><a class="reference internal" href="#production-training-with-optimized-groups">Production Training with Optimized Groups</a></li>
</ul>
</li>
<li><a class="reference internal" href="#python-api-examples">Python API Examples</a><ul>
<li><a class="reference internal" href="#complete-workflow-compute-visualize-and-train">Complete Workflow: Compute, Visualize, and Train</a></li>
<li><a class="reference internal" href="#exploring-different-numbers-of-groups">Exploring Different Numbers of Groups</a></li>
</ul>
</li>
<li><a class="reference internal" href="#analyzing-affinity-results">Analyzing Affinity Results</a><ul>
<li><a class="reference internal" href="#extracting-and-examining-the-affinity-matrix">Extracting and Examining the Affinity Matrix</a></li>
<li><a class="reference internal" href="#reading-the-affinity-matrix">Reading the Affinity Matrix</a></li>
<li><a class="reference internal" href="#visualizing-affinity-with-heatmaps">Visualizing Affinity with Heatmaps</a></li>
<li><a class="reference internal" href="#batch-processing-multiple-datasets">Batch Processing Multiple Datasets</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#practical-workflow">Practical Workflow</a><ul>
<li><a class="reference internal" href="#step-by-step-guide-to-using-task-affinity">Step-by-Step Guide to Using Task Affinity</a><ul>
<li><a class="reference internal" href="#step-1-initial-affinity-computation">Step 1: Initial Affinity Computation</a></li>
<li><a class="reference internal" href="#step-2-determine-optimal-number-of-groups">Step 2: Determine Optimal Number of Groups</a></li>
<li><a class="reference internal" href="#step-3-train-production-model">Step 3: Train Production Model</a></li>
<li><a class="reference internal" href="#step-4-compare-against-baselines">Step 4: Compare Against Baselines</a></li>
</ul>
</li>
<li><a class="reference internal" href="#decision-making-guide">Decision Making Guide</a><ul>
<li><a class="reference internal" href="#when-to-use-task-affinity">When to Use Task Affinity</a></li>
<li><a class="reference internal" href="#how-to-choose-number-of-groups">How to Choose Number of Groups</a></li>
<li><a class="reference internal" href="#interpreting-affinity-values">Interpreting Affinity Values</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#common-configurations">Common Configurations</a><ul>
<li><a class="reference internal" href="#small-admet-panel-5-tasks">Small ADMET Panel (5 tasks)</a></li>
<li><a class="reference internal" href="#standard-admet-panel-8-tasks">Standard ADMET Panel (8 tasks)</a></li>
<li><a class="reference internal" href="#extended-admet-panel-15-tasks">Extended ADMET Panel (15+ tasks)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#performance-considerations">Performance Considerations</a><ul>
<li><a class="reference internal" href="#computational-cost">Computational Cost</a></li>
<li><a class="reference internal" href="#memory-usage">Memory Usage</a></li>
<li><a class="reference internal" href="#id3">When to Use Task Affinity</a></li>
</ul>
</li>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a><ul>
<li><a class="reference internal" href="#common-issues">Common Issues</a><ul>
<li><a class="reference internal" href="#no-gradient-steps">No Gradient Steps</a></li>
<li><a class="reference internal" href="#unstable-affinity-scores">Unstable Affinity Scores</a></li>
<li><a class="reference internal" href="#poor-groupings">Poor Groupings</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#best-practices">Best Practices</a></li>
<li><a class="reference internal" href="#references">References</a></li>
<li><a class="reference internal" href="#api-reference">API Reference</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=8a448e45"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=6dbb43f8"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>