<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../../genindex.html"><link rel="search" title="Search" href="../../../../search.html">
        <link rel="prefetch" href="../../../../_static/logo.svg" as="image">

    <link rel="shortcut icon" href="../../../../_static/logo.svg"><!-- Generated with Sphinx 8.2.3 and Furo 2025.09.25 -->
        <title>admet.model.chemprop.model - OpenADMET Challenge</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-dropdown.css?v=995e94df" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/panels-bootstrap.min.css?v=21c0b90a" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  --color-brand-primary: #007A73;
  --color-brand-content: #C4C7F2;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #007A73;
  --color-brand-content: #C4C7F2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #007A73;
  --color-brand-content: #C4C7F2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../../index.html"><div class="brand">OpenADMET Challenge</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../../../_static/logo.svg" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../api/admet.html">ADMET Package API</a><input aria-label="Toggle navigation of ADMET Package API" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/admet.data.html">Data Pipeline (<code class="docutils literal notranslate"><span class="pre">admet.data</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/admet.model.html">Model Package (<code class="docutils literal notranslate"><span class="pre">admet.model</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/admet.plot.html">Visualization Tools (<code class="docutils literal notranslate"><span class="pre">admet.plot</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/admet.util.html">Utilities (<code class="docutils literal notranslate"><span class="pre">admet.util</span></code>)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../guide/cli.html">CLI Usage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../guide/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../guide/development.html">Development Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../guide/architecture.html">Architecture Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../guide/data_sources.html">Data Sources &amp; Curation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../guide/splitting.html">Dataset Splitting Methodology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../guide/configuration.html">Configuration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../guide/modeling.html">Modeling Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../guide/hpo.html">Hyperparameter Optimization Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../guide/curriculum.html">Curriculum Learning Guide</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for admet.model.chemprop.model</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Chemprop model wrapper for ADMET property prediction</span>
<span class="sd">=====================================================</span>

<span class="sd">This module provides a high-level wrapper around the Chemprop library for</span>
<span class="sd">training and inference of molecular property prediction models using</span>
<span class="sd">message-passing neural networks (MPNNs).</span>

<span class="sd">Key components</span>
<span class="sd">--------------</span>
<span class="sd">- ``ChempropHyperparams``: Dataclass holding all model hyperparameters including</span>
<span class="sd">  optimization settings, message passing configuration, and FFN architecture choices.</span>
<span class="sd">- ``ChempropModel``: Main class that handles data preparation, model construction,</span>
<span class="sd">  training via PyTorch Lightning, and prediction.</span>

<span class="sd">Supported FFN architectures</span>
<span class="sd">---------------------------</span>
<span class="sd">- ``regression``: Standard multi-task regression FFN (default)</span>
<span class="sd">- ``mixture_of_experts``: Mixture of experts regression FFN</span>
<span class="sd">- ``branched``: Branched FFN with shared trunk and task-specific heads</span>

<span class="sd">Example usage</span>
<span class="sd">-------------</span>
<span class="sd">&gt;&gt;&gt; model = ChempropModel(</span>
<span class="sd">...     df_train=train_df,</span>
<span class="sd">...     df_validation=val_df,</span>
<span class="sd">...     smiles_col=&quot;smiles&quot;,</span>
<span class="sd">...     target_cols=[&quot;logD&quot;, &quot;solubility&quot;],</span>
<span class="sd">... )</span>
<span class="sd">&gt;&gt;&gt; model.fit()</span>
<span class="sd">&gt;&gt;&gt; predictions = model.predict(test_df)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">asdict</span><span class="p">,</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">mlflow</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mlflow.data</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mlflow.pytorch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">chemprop</span><span class="w"> </span><span class="kn">import</span> <span class="n">data</span><span class="p">,</span> <span class="n">featurizers</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">nn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">chemprop.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">RegressionFFN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightning</span><span class="w"> </span><span class="kn">import</span> <span class="n">pytorch</span> <span class="k">as</span> <span class="n">pl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightning.pytorch.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="n">EarlyStopping</span><span class="p">,</span> <span class="n">ModelCheckpoint</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightning.pytorch.loggers</span><span class="w"> </span><span class="kn">import</span> <span class="n">MLFlowLogger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">MlflowClient</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlflow.tracking.fluent</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActiveRun</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">omegaconf</span><span class="w"> </span><span class="kn">import</span> <span class="n">DictConfig</span><span class="p">,</span> <span class="n">OmegaConf</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">admet.data.smiles</span><span class="w"> </span><span class="kn">import</span> <span class="n">parallel_canonicalize_smiles</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">admet.data.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">correlation</span><span class="p">,</span> <span class="n">distribution</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">admet.model.chemprop.config</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ChempropConfig</span><span class="p">,</span>
    <span class="n">CurriculumConfig</span><span class="p">,</span>
    <span class="n">DataConfig</span><span class="p">,</span>
    <span class="n">MlflowConfig</span><span class="p">,</span>
    <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">OptimizationConfig</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">admet.model.chemprop.curriculum</span><span class="w"> </span><span class="kn">import</span> <span class="n">CurriculumCallback</span><span class="p">,</span> <span class="n">CurriculumState</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">admet.model.chemprop.curriculum_sampler</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamicCurriculumSampler</span><span class="p">,</span>
    <span class="n">get_quality_indices</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">admet.model.chemprop.ffn</span><span class="w"> </span><span class="kn">import</span> <span class="n">BranchedFFN</span><span class="p">,</span> <span class="n">MixtureOfExpertsRegressionFFN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">admet.plot.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">METRIC_NAMES</span><span class="p">,</span> <span class="n">compute_metrics_df</span><span class="p">,</span> <span class="n">plot_metric_bar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">admet.plot.parity</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_parity</span>

<span class="c1"># Module logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;admet.model.chemprop.model&quot;</span><span class="p">)</span>


<span class="c1"># TODO: think about task weights: _tasks = [1.018, 1.000, 1.364, 1.134, 2.377, 2.373]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CriterionName</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="n">MSE</span> <span class="o">=</span> <span class="s2">&quot;MSE&quot;</span>
    <span class="n">MAE</span> <span class="o">=</span> <span class="s2">&quot;MAE&quot;</span>
    <span class="n">RMSE</span> <span class="o">=</span> <span class="s2">&quot;RMSE&quot;</span>
    <span class="n">SID</span> <span class="o">=</span> <span class="s2">&quot;SID&quot;</span>
    <span class="n">BCE</span> <span class="o">=</span> <span class="s2">&quot;BCE&quot;</span>
    <span class="n">R2</span> <span class="o">=</span> <span class="s2">&quot;R2Score&quot;</span>
    <span class="n">CROSS_ENTROPY</span> <span class="o">=</span> <span class="s2">&quot;CrossEntropy&quot;</span>
    <span class="n">DIRICHLET</span> <span class="o">=</span> <span class="s2">&quot;Dirichlet&quot;</span>
    <span class="n">EVIDENTIAL</span> <span class="o">=</span> <span class="s2">&quot;Evidential&quot;</span>
    <span class="n">MVE</span> <span class="o">=</span> <span class="s2">&quot;MVE&quot;</span>
    <span class="n">QUANTILE</span> <span class="o">=</span> <span class="s2">&quot;Quantile&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolve</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported criterion: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
        <span class="k">return</span> <span class="n">_criterion_from_enum</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_criterion_from_enum</span><span class="p">(</span><span class="n">criterion</span><span class="p">:</span> <span class="n">CriterionName</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="n">criterion</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">attr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Criterion class not found for &#39;</span><span class="si">{</span><span class="n">criterion</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">attr</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to instantiate criterion &#39;</span><span class="si">{</span><span class="n">criterion</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
    <span class="k">return</span> <span class="n">attr</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_sanitize_mlflow_metric_name</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sanitize a metric name for MLflow compatibility.</span>

<span class="sd">    MLflow only allows &#39;_&#39;, &#39;/&#39;, &#39;.&#39; and &#39; &#39; special characters in metric names.</span>
<span class="sd">    This function replaces disallowed characters with safe alternatives.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        The metric name to sanitize.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The sanitized metric name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Replace common problematic characters</span>
    <span class="n">replacements</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;:&quot;</span><span class="p">:</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;;&quot;</span><span class="p">:</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;|&quot;</span><span class="p">:</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">:</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;?&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;*&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s1">&#39;&quot;&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;[&quot;</span><span class="p">:</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;]&quot;</span><span class="p">:</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;(&quot;</span><span class="p">:</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;)&quot;</span><span class="p">:</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;{&quot;</span><span class="p">:</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;}&quot;</span><span class="p">:</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;#&quot;</span><span class="p">:</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;%&quot;</span><span class="p">:</span> <span class="s2">&quot;pct&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&amp;&quot;</span><span class="p">:</span> <span class="s2">&quot;and&quot;</span><span class="p">,</span>
        <span class="s2">&quot;@&quot;</span><span class="p">:</span> <span class="s2">&quot;at&quot;</span><span class="p">,</span>
        <span class="s2">&quot;!&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="s2">&quot;plus&quot;</span><span class="p">,</span>
        <span class="s2">&quot;=&quot;</span><span class="p">:</span> <span class="s2">&quot;eq&quot;</span><span class="p">,</span>
        <span class="s2">&quot;^&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;~&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;`&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">char</span><span class="p">,</span> <span class="n">replacement</span> <span class="ow">in</span> <span class="n">replacements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">replacement</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MLflowModelCheckpoint</span><span class="p">(</span><span class="n">ModelCheckpoint</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model checkpoint callback that registers best models with MLflow.</span>

<span class="sd">    Extends PyTorch Lightning&#39;s ModelCheckpoint to automatically log</span>
<span class="sd">    the best model checkpoint to MLflow when a new best model is saved.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mlflow_client : MlflowClient</span>
<span class="sd">        The MLflow client instance for logging artifacts.</span>
<span class="sd">    run_id : str</span>
<span class="sd">        The MLflow run ID.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Additional arguments passed to ModelCheckpoint.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    mlflow_client : MlflowClient</span>
<span class="sd">        The MLflow client instance.</span>
<span class="sd">    run_id : str</span>
<span class="sd">        The MLflow run ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mlflow_client</span><span class="p">:</span> <span class="n">MlflowClient</span><span class="p">,</span>
        <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span> <span class="o">=</span> <span class="n">mlflow_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_id</span> <span class="o">=</span> <span class="n">run_id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_save_checkpoint</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">trainer</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">,</span>
        <span class="n">pl_module</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when a checkpoint is saved.</span>

<span class="sd">        Logs the checkpoint as an MLflow artifact when a new best model</span>
<span class="sd">        is saved.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        trainer : pl.Trainer</span>
<span class="sd">            The PyTorch Lightning trainer.</span>
<span class="sd">        pl_module : pl.LightningModule</span>
<span class="sd">            The Lightning module being trained.</span>
<span class="sd">        checkpoint : Dict[str, Any]</span>
<span class="sd">            The checkpoint dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_save_checkpoint</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">)</span>

        <span class="c1"># Log best model checkpoint to MLflow when it&#39;s updated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_path</span> <span class="ow">and</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Log the best checkpoint as an artifact</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_run_id</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">best_model_path</span><span class="p">,</span>
                    <span class="n">artifact_path</span><span class="o">=</span><span class="s2">&quot;checkpoints/best&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Log best model score</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_run_id</span><span class="p">,</span>
                        <span class="s2">&quot;best_val_loss&quot;</span><span class="p">,</span>
                        <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_score</span><span class="p">),</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to log checkpoint to MLflow: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ChempropHyperparams</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hyperparameters for Chemprop MPNN model.</span>

<span class="sd">    This dataclass encapsulates all configurable hyperparameters for training</span>
<span class="sd">    a Chemprop message-passing neural network, including optimization settings,</span>
<span class="sd">    message passing architecture, and feed-forward network configuration.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    init_lr : float, default=0.0001</span>
<span class="sd">        Initial learning rate for the optimizer.</span>
<span class="sd">    max_lr : float, default=0.001</span>
<span class="sd">        Maximum learning rate during warmup.</span>
<span class="sd">    final_lr : float, default=0.0001</span>
<span class="sd">        Final learning rate after decay.</span>
<span class="sd">    warmup_epochs : int, default=3</span>
<span class="sd">        Number of epochs for learning rate warmup.</span>
<span class="sd">    patience : int, default=15</span>
<span class="sd">        Number of epochs without improvement before early stopping.</span>
<span class="sd">    max_epochs : int, default=80</span>
<span class="sd">        Maximum number of training epochs.</span>
<span class="sd">    batch_size : int, default=16</span>
<span class="sd">        Batch size for training.</span>
<span class="sd">    num_workers : int, default=0</span>
<span class="sd">        Number of data loading workers.</span>
<span class="sd">    seed : int, default=12345</span>
<span class="sd">        Random seed for reproducibility.</span>
<span class="sd">    depth : int, default=3</span>
<span class="sd">        Number of message passing iterations.</span>
<span class="sd">    message_hidden_dim : int, default=300</span>
<span class="sd">        Hidden dimension for message passing layers.</span>
<span class="sd">    num_layers : int, default=2</span>
<span class="sd">        Number of layers in the feed-forward network.</span>
<span class="sd">    hidden_dim : int, default=300</span>
<span class="sd">        Hidden dimension for FFN layers.</span>
<span class="sd">    dropout : float, default=0.0</span>
<span class="sd">        Dropout probability.</span>
<span class="sd">    criterion : str, default=&#39;MSE&#39;</span>
<span class="sd">        Loss criterion. Options: &#39;MSE&#39;, &#39;SID&#39;, &#39;BCE&#39;, &#39;CrossEntropy&#39;,</span>
<span class="sd">        &#39;Dirichlet&#39;, &#39;Evidential&#39;, &#39;MVE&#39;, &#39;Quantile&#39;.</span>
<span class="sd">    ffn_type : str, default=&#39;regression&#39;</span>
<span class="sd">        Type of feed-forward network. Options: &#39;regression&#39;,</span>
<span class="sd">        &#39;mixture_of_experts&#39;, &#39;branched&#39;.</span>
<span class="sd">    trunk_n_layers : int, default=1</span>
<span class="sd">        Number of trunk layers for branched FFN.</span>
<span class="sd">    trunk_hidden_dim : int, default=300</span>
<span class="sd">        Hidden dimension for trunk layers in branched FFN.</span>
<span class="sd">    n_experts : int, default=3</span>
<span class="sd">        Number of experts for mixture of experts FFN.</span>
<span class="sd">    batch_norm : bool, default=True</span>
<span class="sd">        Whether to use batch normalization in MPNN.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Optimization</span>
    <span class="n">init_lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0e-4</span>
    <span class="n">max_lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0e-3</span>
    <span class="n">final_lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0e-4</span>
    <span class="n">warmup_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">patience</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">max_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12345</span>

    <span class="c1"># Message passing</span>
    <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">message_hidden_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">600</span>

    <span class="c1"># Feed forward</span>
    <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">num_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">hidden_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">600</span>
    <span class="c1"># options: &quot;MAE&quot;, &quot;MSE&quot;, &quot;RMSE&quot;, &quot;SID&quot;, &quot;BCE&quot;, &quot;CrossEntropy&quot;, &quot;Dirichlet&quot;, &quot;Evidential&quot;, &quot;MVE&quot;, &quot;Quantile&quot;</span>
    <span class="n">criterion</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;MAE&quot;</span>
    <span class="n">ffn_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;regression&quot;</span>  <span class="c1"># options: &#39;regression&#39;, &#39;mixture_of_experts&#39;, &#39;branched&#39;</span>

    <span class="c1"># Branched FFN</span>
    <span class="n">trunk_n_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">trunk_hidden_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">600</span>

    <span class="c1"># Mixture of Experts FFN</span>
    <span class="n">n_experts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="c1"># MPNN</span>
    <span class="n">batch_norm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>


<div class="viewcode-block" id="ChempropModel">
<a class="viewcode-back" href="../../../../api/admet.model.html#admet.model.chemprop.ChempropModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ChempropModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    High-level wrapper for Chemprop MPNN training and inference.</span>

<span class="sd">    This class handles the full workflow of preparing data, building the model,</span>
<span class="sd">    training with PyTorch Lightning, and generating predictions. It supports</span>
<span class="sd">    multiple FFN architectures and automatic target normalization.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_train : pandas.DataFrame</span>
<span class="sd">        Training dataframe containing SMILES and target columns.</span>
<span class="sd">    df_validation : pandas.DataFrame or None, optional</span>
<span class="sd">        Validation dataframe for early stopping and model selection.</span>
<span class="sd">    df_test : pandas.DataFrame or None, optional</span>
<span class="sd">        Test dataframe (not used during training).</span>
<span class="sd">    smiles_col : str, default=&#39;smiles&#39;</span>
<span class="sd">        Column name containing SMILES strings.</span>
<span class="sd">    target_cols : list[str], default=[]</span>
<span class="sd">        List of target column names for multi-task prediction.</span>
<span class="sd">    target_weights : list[float], default=[]</span>
<span class="sd">        Per-task weights for the loss function. If empty, all tasks</span>
<span class="sd">        are weighted equally.</span>
<span class="sd">    output_dir : pathlib.Path or None, optional</span>
<span class="sd">        Directory to save model checkpoints.</span>
<span class="sd">    progress_bar : bool, default=False</span>
<span class="sd">        Whether to show training progress bar.</span>
<span class="sd">    hyperparams : ChempropHyperparams or None, optional</span>
<span class="sd">        Model hyperparameters. If None, defaults are used.</span>
<span class="sd">    mlflow_tracking : bool, default=True</span>
<span class="sd">        Whether to enable MLflow tracking for params, metrics, and artifacts.</span>
<span class="sd">    mlflow_experiment_name : str, default=&#39;chemprop&#39;</span>
<span class="sd">        MLflow experiment name to log runs under.</span>
<span class="sd">    mlflow_run_name : str or None, optional</span>
<span class="sd">        Optional run name for the MLflow run.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    featurizer : SimpleMoleculeMolGraphFeaturizer</span>
<span class="sd">        Molecular graph featurizer.</span>
<span class="sd">    mpnn : models.MPNN</span>
<span class="sd">        The underlying Chemprop MPNN model.</span>
<span class="sd">    trainer : pl.Trainer</span>
<span class="sd">        PyTorch Lightning trainer instance.</span>
<span class="sd">    scaler : StandardScaler</span>
<span class="sd">        Target normalization scaler fitted on training data.</span>
<span class="sd">    metrics : list</span>
<span class="sd">        Evaluation metrics (RMSE, MAE, R2).</span>
<span class="sd">    mlflow_run_id : str or None</span>
<span class="sd">        The MLflow run ID if tracking is enabled.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; model = ChempropModel(</span>
<span class="sd">    ...     df_train=train_df,</span>
<span class="sd">    ...     df_validation=val_df,</span>
<span class="sd">    ...     smiles_col=&quot;smiles&quot;,</span>
<span class="sd">    ...     target_cols=[&quot;logD&quot;, &quot;solubility&quot;],</span>
<span class="sd">    ...     mlflow_tracking=True,</span>
<span class="sd">    ...     mlflow_experiment_name=&quot;admet_chemprop&quot;,</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; model.fit()</span>
<span class="sd">    &gt;&gt;&gt; predictions = model.predict(test_df)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">df_validation</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">df_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">smiles_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;smiles&quot;</span><span class="p">,</span>
        <span class="n">target_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">target_weights</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">hyperparams</span><span class="p">:</span> <span class="n">ChempropHyperparams</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mlflow_tracking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">mlflow_tracking_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mlflow_experiment_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;chemprop&quot;</span><span class="p">,</span>
        <span class="n">mlflow_run_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mlflow_run_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mlflow_parent_run_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mlflow_nested</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">curriculum_config</span><span class="p">:</span> <span class="n">CurriculumConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">curriculum_state</span><span class="p">:</span> <span class="n">CurriculumState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize ChempropModel with data and configuration.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df_train : pandas.DataFrame</span>
<span class="sd">            Training dataframe containing SMILES and target columns.</span>
<span class="sd">        df_validation : pandas.DataFrame or None, optional</span>
<span class="sd">            Validation dataframe for early stopping.</span>
<span class="sd">        df_test : pandas.DataFrame or None, optional</span>
<span class="sd">            Test dataframe (stored but not used during training).</span>
<span class="sd">        smiles_col : str, default=&#39;smiles&#39;</span>
<span class="sd">            Column name containing SMILES strings.</span>
<span class="sd">        target_cols : list[str], default=[]</span>
<span class="sd">            List of target column names.</span>
<span class="sd">        target_weights : list[float], default=[]</span>
<span class="sd">            Per-task loss weights.</span>
<span class="sd">        output_dir : pathlib.Path or None, optional</span>
<span class="sd">            Directory for saving checkpoints.</span>
<span class="sd">        progress_bar : bool, default=False</span>
<span class="sd">            Whether to display progress bar during training.</span>
<span class="sd">        hyperparams : ChempropHyperparams or None, optional</span>
<span class="sd">            Model hyperparameters.</span>
<span class="sd">        mlflow_tracking : bool, default=True</span>
<span class="sd">            Whether to enable MLflow tracking.</span>
<span class="sd">        mlflow_tracking_uri : str or None, optional</span>
<span class="sd">            MLflow tracking server URI. If None, uses default.</span>
<span class="sd">        mlflow_experiment_name : str, default=&#39;chemprop&#39;</span>
<span class="sd">            MLflow experiment name.</span>
<span class="sd">        mlflow_run_name : str or None, optional</span>
<span class="sd">            Optional MLflow run name.</span>
<span class="sd">        mlflow_run_id : str or None, optional</span>
<span class="sd">            Existing MLflow run ID to attach to. If provided, the model</span>
<span class="sd">            will log to this existing run instead of creating a new one.</span>
<span class="sd">        mlflow_parent_run_id : str or None, optional</span>
<span class="sd">            Parent run ID for creating nested runs. Used for ensemble training.</span>
<span class="sd">        mlflow_nested : bool, default=False</span>
<span class="sd">            Whether to create a nested run under the parent_run_id.</span>
<span class="sd">        curriculum_config : CurriculumConfig or None, optional</span>
<span class="sd">            Curriculum learning configuration. If None, curriculum learning</span>
<span class="sd">            is disabled.</span>
<span class="sd">        curriculum_state : CurriculumState or None, optional</span>
<span class="sd">            Shared curriculum state for ensemble training. If None and</span>
<span class="sd">            curriculum_config is enabled, a new state is created.</span>
<span class="sd">        data_dir : str or None, optional</span>
<span class="sd">            Path to the data directory. Used to parse and log structured</span>
<span class="sd">            parameters like split_type, version, quality, cluster_method,</span>
<span class="sd">            split_method, split, and fold.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">smiles_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_cols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">output_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">progress_bar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">:</span> <span class="n">ChempropHyperparams</span> <span class="o">=</span> <span class="n">hyperparams</span> <span class="ow">or</span> <span class="n">ChempropHyperparams</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dir</span>

        <span class="c1"># Curriculum learning configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_config</span><span class="p">:</span> <span class="n">CurriculumConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">curriculum_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_state</span><span class="p">:</span> <span class="n">CurriculumState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">curriculum_state</span>

        <span class="c1"># Initialize curriculum state if config is enabled but state not provided</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_config</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_state</span> <span class="o">=</span> <span class="n">CurriculumState</span><span class="p">(</span>
                    <span class="n">qualities</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curriculum_config</span><span class="o">.</span><span class="n">qualities</span><span class="p">),</span>
                    <span class="n">patience</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">curriculum_config</span><span class="o">.</span><span class="n">patience</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># Store quality column for later use</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quality_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_config</span><span class="o">.</span><span class="n">quality_col</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quality_col</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># MLflow configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">mlflow_tracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlflow_tracking_uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_experiment_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">mlflow_experiment_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlflow_run_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlflow_run_id</span>  <span class="c1"># For attaching to existing run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_parent_run_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlflow_parent_run_id</span>  <span class="c1"># For nested runs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_nested</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">mlflow_nested</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MLFlowLogger</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MlflowClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_run</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ActiveRun</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Active run context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_temp_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Initialize MLflow run at init to keep active context throughout lifecycle</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_mlflow</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">MAE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">MSE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">RMSE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">R2Score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">=</span> <span class="n">featurizers</span><span class="o">.</span><span class="n">SimpleMoleculeMolGraphFeaturizer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agg</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">NormAggregation</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mp</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BondMessagePassing</span><span class="p">(</span>
            <span class="n">d_h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">message_hidden_dim</span><span class="p">,</span>
            <span class="n">depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
            <span class="n">dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffn</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpnn</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">df_train</span><span class="p">,</span>
            <span class="s2">&quot;validation&quot;</span><span class="p">:</span> <span class="n">df_validation</span><span class="p">,</span>
            <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">df_test</span><span class="p">,</span>
            <span class="s2">&quot;blind&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Populated via from_config or directly</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;validation&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_dataloaders</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_trainer</span><span class="p">()</span>

<div class="viewcode-block" id="ChempropModel.from_config">
<a class="viewcode-back" href="../../../../api/admet.model.html#admet.model.chemprop.ChempropModel.from_config">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_config</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ChempropConfig</span><span class="p">,</span> <span class="n">DictConfig</span><span class="p">],</span>
        <span class="n">df_train</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">df_validation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">df_test</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">df_blind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ChempropModel&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a ChempropModel from an OmegaConf configuration.</span>

<span class="sd">        This factory method allows creating a model from a YAML configuration</span>
<span class="sd">        file, enabling reproducible and configurable experiments.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config : ChempropConfig or DictConfig</span>
<span class="sd">            Configuration object containing data, model, optimization,</span>
<span class="sd">            and MLflow settings. Can be created from a YAML file using</span>
<span class="sd">            ``OmegaConf.load()`` and ``OmegaConf.merge()``.</span>
<span class="sd">        df_train : pandas.DataFrame, optional</span>
<span class="sd">            Pre-loaded training dataframe. If None, will be loaded from</span>
<span class="sd">            ``config.data.train_file``.</span>
<span class="sd">        df_validation : pandas.DataFrame, optional</span>
<span class="sd">            Pre-loaded validation dataframe. If None and</span>
<span class="sd">            ``config.data.validation_file`` is set, will be loaded from file.</span>
<span class="sd">        df_test : pandas.DataFrame, optional</span>
<span class="sd">            Pre-loaded test dataframe. If None and ``config.data.test_file``</span>
<span class="sd">            is set, will be loaded from file.</span>
<span class="sd">        df_blind : pandas.DataFrame, optional</span>
<span class="sd">            Pre-loaded blind test dataframe. Stored as an attribute but not</span>
<span class="sd">            used during training.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ChempropModel</span>
<span class="sd">            Initialized model ready for training.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from omegaconf import OmegaConf</span>
<span class="sd">        &gt;&gt;&gt; config = OmegaConf.merge(</span>
<span class="sd">        ...     OmegaConf.structured(ChempropConfig),</span>
<span class="sd">        ...     OmegaConf.load(&quot;experiment.yaml&quot;)</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; model = ChempropModel.from_config(config)</span>
<span class="sd">        &gt;&gt;&gt; model.fit()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load dataframes if not provided</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df_train</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">/</span> <span class="s2">&quot;train.csv&quot;</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">df_validation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_validation</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">/</span> <span class="s2">&quot;validation.csv&quot;</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">df_test</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">test_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">test_file</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">df_blind</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">blind_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_blind</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">blind_file</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Canonicalize SMILES</span>
        <span class="n">df_train</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">parallel_canonicalize_smiles</span><span class="p">(</span><span class="n">df_train</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">df_validation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_validation</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">parallel_canonicalize_smiles</span><span class="p">(</span>
                <span class="n">df_validation</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">df_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_test</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">parallel_canonicalize_smiles</span><span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">df_blind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_blind</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">parallel_canonicalize_smiles</span><span class="p">(</span><span class="n">df_blind</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="c1"># Build hyperparams from config</span>
        <span class="n">hyperparams</span> <span class="o">=</span> <span class="n">ChempropHyperparams</span><span class="p">(</span>
            <span class="c1"># Optimization</span>
            <span class="n">init_lr</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optimization</span><span class="o">.</span><span class="n">init_lr</span><span class="p">,</span>
            <span class="n">max_lr</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optimization</span><span class="o">.</span><span class="n">max_lr</span><span class="p">,</span>
            <span class="n">final_lr</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optimization</span><span class="o">.</span><span class="n">final_lr</span><span class="p">,</span>
            <span class="n">warmup_epochs</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optimization</span><span class="o">.</span><span class="n">warmup_epochs</span><span class="p">,</span>
            <span class="n">patience</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optimization</span><span class="o">.</span><span class="n">patience</span><span class="p">,</span>
            <span class="n">max_epochs</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optimization</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optimization</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optimization</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optimization</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
            <span class="n">criterion</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optimization</span><span class="o">.</span><span class="n">criterion</span><span class="p">,</span>
            <span class="c1"># Model architecture</span>
            <span class="n">depth</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
            <span class="n">message_hidden_dim</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">message_hidden_dim</span><span class="p">,</span>
            <span class="n">dropout</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
            <span class="n">num_layers</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">num_layers</span><span class="p">,</span>
            <span class="n">hidden_dim</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">,</span>
            <span class="n">batch_norm</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">batch_norm</span><span class="p">,</span>
            <span class="n">ffn_type</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ffn_type</span><span class="p">,</span>
            <span class="n">trunk_n_layers</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">trunk_n_layers</span><span class="p">,</span>
            <span class="n">trunk_hidden_dim</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">trunk_hidden_dim</span><span class="p">,</span>
            <span class="n">n_experts</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">n_experts</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Determine output directory</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">output_dir</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># Create model instance</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">df_train</span><span class="o">=</span><span class="n">df_train</span><span class="p">,</span>
            <span class="n">df_validation</span><span class="o">=</span><span class="n">df_validation</span><span class="p">,</span>
            <span class="n">df_test</span><span class="o">=</span><span class="n">df_test</span><span class="p">,</span>
            <span class="n">smiles_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">,</span>
            <span class="n">target_cols</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">target_cols</span><span class="p">),</span>
            <span class="n">target_weights</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">target_weights</span><span class="p">)</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">target_weights</span> <span class="k">else</span> <span class="p">[],</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
            <span class="n">progress_bar</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optimization</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">,</span>
            <span class="n">hyperparams</span><span class="o">=</span><span class="n">hyperparams</span><span class="p">,</span>
            <span class="n">mlflow_tracking</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">mlflow</span><span class="o">.</span><span class="n">tracking</span><span class="p">,</span>
            <span class="n">mlflow_tracking_uri</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">mlflow</span><span class="o">.</span><span class="n">tracking_uri</span><span class="p">,</span>
            <span class="n">mlflow_experiment_name</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">mlflow</span><span class="o">.</span><span class="n">experiment_name</span><span class="p">,</span>
            <span class="n">mlflow_run_name</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">mlflow</span><span class="o">.</span><span class="n">run_name</span><span class="p">,</span>
            <span class="n">mlflow_run_id</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">mlflow</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
            <span class="n">mlflow_parent_run_id</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">mlflow</span><span class="o">.</span><span class="n">parent_run_id</span><span class="p">,</span>
            <span class="n">mlflow_nested</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">mlflow</span><span class="o">.</span><span class="n">nested</span><span class="p">,</span>
            <span class="n">curriculum_config</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">curriculum</span><span class="p">,</span>
            <span class="n">data_dir</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Store blind dataframe for later prediction</span>
        <span class="n">model</span><span class="o">.</span><span class="n">dataframes</span><span class="p">[</span><span class="s2">&quot;blind&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_blind</span>

        <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="ChempropModel.to_config">
<a class="viewcode-back" href="../../../../api/admet.model.html#admet.model.chemprop.ChempropModel.to_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChempropConfig</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export current model configuration to a ChempropConfig object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ChempropConfig</span>
<span class="sd">            Configuration object that can be saved to YAML using OmegaConf.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; config = model.to_config()</span>
<span class="sd">        &gt;&gt;&gt; OmegaConf.save(config, &quot;experiment_config.yaml&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ChempropConfig</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">DataConfig</span><span class="p">(</span>
                <span class="n">data_dir</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># Not available after loading</span>
                <span class="n">smiles_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">,</span>
                <span class="n">target_cols</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">),</span>
                <span class="n">target_weights</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">),</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">model</span><span class="o">=</span><span class="n">ModelConfig</span><span class="p">(</span>
                <span class="n">depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
                <span class="n">message_hidden_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">message_hidden_dim</span><span class="p">,</span>
                <span class="n">dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
                <span class="n">num_layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">num_layers</span><span class="p">,</span>
                <span class="n">hidden_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">,</span>
                <span class="n">batch_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">batch_norm</span><span class="p">,</span>
                <span class="n">ffn_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">ffn_type</span><span class="p">,</span>
                <span class="n">trunk_n_layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">trunk_n_layers</span><span class="p">,</span>
                <span class="n">trunk_hidden_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">trunk_hidden_dim</span><span class="p">,</span>
                <span class="n">n_experts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">n_experts</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">optimization</span><span class="o">=</span><span class="n">OptimizationConfig</span><span class="p">(</span>
                <span class="n">criterion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">criterion</span><span class="p">,</span>
                <span class="n">init_lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">init_lr</span><span class="p">,</span>
                <span class="n">max_lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">max_lr</span><span class="p">,</span>
                <span class="n">final_lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">final_lr</span><span class="p">,</span>
                <span class="n">warmup_epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">warmup_epochs</span><span class="p">,</span>
                <span class="n">patience</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">patience</span><span class="p">,</span>
                <span class="n">max_epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
                <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                <span class="n">progress_bar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">mlflow</span><span class="o">=</span><span class="n">MlflowConfig</span><span class="p">(</span>
                <span class="n">tracking</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking</span><span class="p">,</span>
                <span class="n">tracking_uri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking_uri</span><span class="p">,</span>
                <span class="n">experiment_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_experiment_name</span><span class="p">,</span>
                <span class="n">run_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_name</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">curriculum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">curriculum_config</span> <span class="ow">or</span> <span class="n">CurriculumConfig</span><span class="p">(),</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_dataloaders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare PyTorch dataloaders for train/validation/test splits.</span>

<span class="sd">        This method converts dataframes to Chemprop MoleculeDatasets,</span>
<span class="sd">        fits a target scaler on training data, and creates dataloaders</span>
<span class="sd">        for each split.</span>

<span class="sd">        If curriculum learning is enabled, the training dataloader uses a</span>
<span class="sd">        WeightedRandomSampler based on the curriculum phase instead of</span>
<span class="sd">        uniform shuffling.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">datapoints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Store quality labels for curriculum sampling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quality_labels</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;validation&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;validation&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="p">[</span><span class="n">split</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">smis</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="c1"># Canonicalize SMILES</span>
            <span class="n">smis</span> <span class="o">=</span> <span class="n">parallel_canonicalize_smiles</span><span class="p">(</span><span class="n">smis</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

            <span class="c1"># Extract quality labels if curriculum is enabled</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quality_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">quality_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_quality_labels</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">quality_col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="n">datapoints</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">MoleculeDatapoint</span><span class="o">.</span><span class="n">from_smi</span><span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">smi</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">smis</span><span class="p">,</span> <span class="n">ys</span><span class="p">)]</span>
            <span class="n">datasets</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">MoleculeDataset</span><span class="p">(</span><span class="n">datapoints</span><span class="p">[</span><span class="n">split</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizer</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">split</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="n">split</span><span class="p">]</span><span class="o">.</span><span class="n">normalize_targets</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">UnscaleTransform</span><span class="o">.</span><span class="n">from_standard_scaler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">split</span> <span class="o">==</span> <span class="s2">&quot;validation&quot;</span><span class="p">:</span>
                <span class="n">datasets</span><span class="p">[</span><span class="n">split</span><span class="p">]</span><span class="o">.</span><span class="n">normalize_targets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="p">)</span>

            <span class="c1"># Build dataloader with curriculum sampling for training if enabled</span>
            <span class="k">if</span> <span class="n">split</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quality_labels</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Use dynamic curriculum-aware sampling that updates with phase changes</span>
                <span class="n">seed</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_config</span><span class="o">.</span><span class="n">seed</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_config</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_config</span><span class="o">.</span><span class="n">seed</span>
                    <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">seed</span>
                <span class="p">)</span>
                <span class="n">sampler</span> <span class="o">=</span> <span class="n">DynamicCurriculumSampler</span><span class="p">(</span>
                    <span class="n">quality_labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_quality_labels</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">],</span>
                    <span class="n">curriculum_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">curriculum_state</span><span class="p">,</span>
                    <span class="n">num_samples</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="n">split</span><span class="p">]),</span>
                    <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">build_dataloader</span><span class="p">(</span>
                    <span class="n">datasets</span><span class="p">[</span><span class="n">split</span><span class="p">],</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
                    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Sampler handles this</span>
                    <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Dynamic curriculum sampling enabled for training: phase=</span><span class="si">%s</span><span class="s2">, qualities=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_state</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_state</span><span class="o">.</span><span class="n">qualities</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Standard dataloader (shuffle for train, no shuffle for val/test)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">build_dataloader</span><span class="p">(</span>
                    <span class="n">datasets</span><span class="p">[</span><span class="n">split</span><span class="p">],</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
                    <span class="n">shuffle</span><span class="o">=</span><span class="p">(</span><span class="n">split</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">),</span>
                    <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build the MPNN model based on hyperparameters.</span>

<span class="sd">        Constructs the feed-forward network (FFN) based on ``ffn_type``</span>
<span class="sd">        hyperparameter and assembles the full MPNN with message passing,</span>
<span class="sd">        aggregation, and prediction components.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If ``ffn_type`` is not one of &#39;regression&#39;, &#39;mixture_of_experts&#39;,</span>
<span class="sd">            or &#39;branched&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">criterion</span> <span class="o">=</span> <span class="n">CriterionName</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">criterion</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">ffn_type</span> <span class="o">==</span> <span class="s2">&quot;mixture_of_experts&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ffn</span> <span class="o">=</span> <span class="n">MixtureOfExpertsRegressionFFN</span><span class="p">(</span>
                <span class="n">n_tasks</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">),</span>
                <span class="n">n_experts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">n_experts</span><span class="p">,</span>
                <span class="n">input_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">message_hidden_dim</span><span class="p">,</span>
                <span class="n">hidden_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">,</span>
                <span class="n">n_layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">num_layers</span><span class="p">,</span>
                <span class="n">dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
                <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span><span class="p">,</span>
                <span class="n">task_weights</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">output_transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">ffn_type</span> <span class="o">==</span> <span class="s2">&quot;branched&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ffn</span> <span class="o">=</span> <span class="n">BranchedFFN</span><span class="p">(</span>
                <span class="n">task_groups</span><span class="o">=</span><span class="p">[[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">))],</span>
                <span class="n">n_tasks</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">),</span>
                <span class="n">input_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">message_hidden_dim</span><span class="p">,</span>
                <span class="n">hidden_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">,</span>
                <span class="n">trunk_n_layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">trunk_n_layers</span><span class="p">,</span>
                <span class="n">trunk_hidden_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">trunk_hidden_dim</span><span class="p">,</span>
                <span class="n">trunk_dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
                <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span><span class="p">,</span>
                <span class="n">task_weights</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">output_transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">ffn_type</span> <span class="o">==</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ffn</span> <span class="o">=</span> <span class="n">RegressionFFN</span><span class="p">(</span>
                <span class="n">n_tasks</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">),</span>
                <span class="n">input_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">message_hidden_dim</span><span class="p">,</span>
                <span class="n">hidden_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">,</span>
                <span class="n">n_layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">num_layers</span><span class="p">,</span>
                <span class="n">dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
                <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span><span class="p">,</span>
                <span class="n">task_weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">,</span>
                <span class="n">output_transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported ffn_type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">ffn_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mpnn</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">MPNN</span><span class="p">(</span>
            <span class="n">message_passing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">,</span>
            <span class="n">agg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agg</span><span class="p">,</span>
            <span class="n">predictor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ffn</span><span class="p">,</span>
            <span class="n">batch_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">batch_norm</span><span class="p">,</span>
            <span class="n">metrics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span>
            <span class="n">warmup_epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">warmup_epochs</span><span class="p">,</span>
            <span class="n">init_lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">init_lr</span><span class="p">,</span>
            <span class="n">max_lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">max_lr</span><span class="p">,</span>
            <span class="n">final_lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">final_lr</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_mlflow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize MLflow tracking with an active run context.</span>

<span class="sd">        Creates the MLflow client and starts an active run that persists</span>
<span class="sd">        throughout the model&#39;s lifecycle. This allows all logging operations</span>
<span class="sd">        to use the same run context without repeatedly opening/closing runs.</span>

<span class="sd">        Supports three modes:</span>
<span class="sd">        1. Attach to existing run (mlflow_run_id is set)</span>
<span class="sd">        2. Create nested run under parent (mlflow_nested=True, mlflow_parent_run_id is set)</span>
<span class="sd">        3. Create new standalone run (default)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking_uri</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking_uri</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_experiment_name</span><span class="p">)</span>

        <span class="c1"># Enable system metrics logging (CPU, memory, GPU, etc.)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">enable_system_metrics_logging</span><span class="p">()</span>

        <span class="c1"># Determine which mode to use</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Mode 1: Attach to existing run (for ensemble nested runs)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_run</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;MLflow attached to existing run: run_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_nested</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_parent_run_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Mode 2: Create nested run under parent</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_run</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span>
                <span class="n">run_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_name</span><span class="p">,</span>
                <span class="n">nested</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">parent_run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_parent_run_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_run</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_id</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;MLflow nested run started: run_id=</span><span class="si">%s</span><span class="s2">, parent_run_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_parent_run_id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Mode 3: Start a new standalone run</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_run</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_run</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_id</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;MLflow new run started: run_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">)</span>

        <span class="c1"># Create shared MlflowClient for direct API calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span> <span class="o">=</span> <span class="n">MlflowClient</span><span class="p">(</span><span class="n">tracking_uri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking_uri</span><span class="p">)</span>

<div class="viewcode-block" id="ChempropModel.close">
<a class="viewcode-back" href="../../../../api/admet.model.html#admet.model.chemprop.ChempropModel.close">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close the MLflow run and clean up resources.</span>

<span class="sd">        This should be called when you&#39;re done with the model to properly</span>
<span class="sd">        end the MLflow run. If not called explicitly, the run will remain</span>
<span class="sd">        active until the process exits.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Clean up temp checkpoint directory if it was created</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_temp_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_temp_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_temp_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_temp_dir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># End the MLflow run</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">end_run</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;MLflow run ended: run_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_run</span> <span class="o">=</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Destructor to ensure MLflow run is closed.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># Ignore errors during cleanup</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_trainer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure PyTorch Lightning trainer with callbacks.</span>

<span class="sd">        Sets up model checkpointing (saves best and last checkpoints)</span>
<span class="sd">        and early stopping based on validation loss. When MLflow tracking</span>
<span class="sd">        is enabled, uses MLflowModelCheckpoint to register models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">set_float32_matmul_precision</span><span class="p">(</span><span class="s2">&quot;medium&quot;</span><span class="p">)</span>

        <span class="n">earlystopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span>
            <span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span>
            <span class="n">patience</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">patience</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Configure logger and checkpointing based on mlflow_tracking setting</span>
        <span class="n">pl_logger</span><span class="p">:</span> <span class="n">MLFlowLogger</span> <span class="o">|</span> <span class="nb">bool</span>
        <span class="n">callbacks_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">earlystopping</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use existing MLflow run started in _init_mlflow()</span>
            <span class="c1"># MLFlowLogger with run_id will attach to the existing run</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_logger</span> <span class="o">=</span> <span class="n">MLFlowLogger</span><span class="p">(</span>
                <span class="n">experiment_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_experiment_name</span><span class="p">,</span>
                <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span>  <span class="c1"># Attach to existing run</span>
                <span class="n">tracking_uri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking_uri</span><span class="p">,</span>
                <span class="n">log_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># We handle model logging manually</span>
                <span class="n">save_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Don&#39;t create local artifact directory</span>
            <span class="p">)</span>
            <span class="n">pl_logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_logger</span>

            <span class="c1"># Use MLflow-enabled checkpointing with shared client</span>
            <span class="c1"># Use output_dir if provided, otherwise use a temp directory for checkpoints</span>
            <span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span>
            <span class="k">if</span> <span class="n">checkpoint_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Create a temp directory that will be cleaned up</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_temp_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;chemprop_ckpt_&quot;</span><span class="p">))</span>
                <span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_temp_dir</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_temp_dir</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">checkpointing</span> <span class="o">=</span> <span class="n">MLflowModelCheckpoint</span><span class="p">(</span>
                <span class="n">mlflow_client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="p">,</span>  <span class="c1"># type: ignore[arg-type]</span>
                <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span>
                <span class="n">dirpath</span><span class="o">=</span><span class="n">checkpoint_dir</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;best-</span><span class="si">{epoch:04}</span><span class="s2">-</span><span class="si">{val_loss:.2f}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span>
                <span class="n">save_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">callbacks_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">checkpointing</span><span class="p">)</span>

            <span class="c1"># NOTE: EpochMetricsCallback removed - calling trainer.predict() inside</span>
            <span class="c1"># callbacks corrupts Lightning&#39;s internal state. Detailed metrics are</span>
            <span class="c1"># computed at training end via _log_evaluation_metrics() instead.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pl_logger</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Standard checkpointing without MLflow</span>
            <span class="n">checkpointing</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span>  <span class="c1"># type: ignore[no-redef,assignment]</span>
                <span class="n">dirpath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;best-</span><span class="si">{epoch:04}</span><span class="s2">-</span><span class="si">{val_loss:.2f}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span>
                <span class="n">save_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">callbacks_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">checkpointing</span><span class="p">)</span>

        <span class="c1"># Add curriculum callback if curriculum learning is enabled</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Get configuration options for curriculum callback</span>
            <span class="n">reset_es</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_config</span><span class="o">.</span><span class="n">reset_early_stopping_on_phase_change</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_config</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="n">log_per_quality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_config</span><span class="o">.</span><span class="n">log_per_quality_metrics</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_config</span> <span class="k">else</span> <span class="kc">True</span>
            <span class="n">val_quality_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quality_labels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validation&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_quality_labels&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">curriculum_callback</span> <span class="o">=</span> <span class="n">CurriculumCallback</span><span class="p">(</span>
                <span class="n">curr_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">curriculum_state</span><span class="p">,</span>
                <span class="n">monitor_metric</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span>  <span class="c1"># Use overall validation loss</span>
                <span class="n">reset_early_stopping_on_phase_change</span><span class="o">=</span><span class="n">reset_es</span><span class="p">,</span>
                <span class="n">log_per_quality_metrics</span><span class="o">=</span><span class="n">log_per_quality</span><span class="p">,</span>
                <span class="n">quality_labels</span><span class="o">=</span><span class="n">val_quality_labels</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">callbacks_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curriculum_callback</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Curriculum callback added: monitoring &#39;val_loss&#39;, &quot;</span> <span class="s2">&quot;reset_early_stopping=</span><span class="si">%s</span><span class="s2">, log_per_quality=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">reset_es</span><span class="p">,</span>
                <span class="n">log_per_quality</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span>
            <span class="n">logger</span><span class="o">=</span><span class="n">pl_logger</span><span class="p">,</span>
            <span class="n">enable_checkpointing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">enable_progress_bar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">,</span>
            <span class="n">accelerator</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="n">devices</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">max_epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">,</span>
            <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks_list</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="ChempropModel.fit">
<a class="viewcode-back" href="../../../../api/admet.model.html#admet.model.chemprop.ChempropModel.fit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Train the MPNN model.</span>

<span class="sd">        Runs training using the PyTorch Lightning trainer with the</span>
<span class="sd">        configured train and validation dataloaders. Handles keyboard</span>
<span class="sd">        interrupts gracefully, allowing the model to be used for</span>
<span class="sd">        prediction even if training is interrupted.</span>

<span class="sd">        When MLflow tracking is enabled, logs hyperparameters at the</span>
<span class="sd">        start of training, and logs metrics, artifacts, and registers</span>
<span class="sd">        the model upon completion.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if training completed normally, False if interrupted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Log hyperparameters and dataset info at start of training</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;MLflow tracking enabled: client=</span><span class="si">%s</span><span class="s2">, run_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_hyperparams</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_dataset_info</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;MLflow tracking skipped: tracking=</span><span class="si">%s</span><span class="s2">, logger=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_logger</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting training...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mpnn</span><span class="p">,</span>
                <span class="n">train_dataloaders</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">],</span>
                <span class="n">val_dataloaders</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;trainer.fit() returned successfully&quot;</span><span class="p">)</span>
            <span class="n">completed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Training interrupted by user. Model state preserved.&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;You can still use model.predict() with the current weights.&quot;</span><span class="p">)</span>
            <span class="n">completed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Training finished: completed=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">completed</span><span class="p">)</span>

        <span class="c1"># Log evaluation metrics and final artifacts</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Post-training: logging evaluation metrics and artifacts&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_evaluation_metrics</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_training_artifacts</span><span class="p">(</span><span class="n">completed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Post-training skipped: tracking=</span><span class="si">%s</span><span class="s2">, logger=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_logger</span><span class="p">)</span>

        <span class="c1"># Generate evaluation plots for train and validation sets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_training_plots</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">completed</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_training_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate evaluation plots for training and validation sets.</span>

<span class="sd">        Creates parity plots comparing true vs predicted values for each</span>
<span class="sd">        target column on both training and validation datasets. Plots are</span>
<span class="sd">        logged to MLflow if active, saved to output_dir if specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if we should generate plots</span>
        <span class="n">should_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">should_save</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Generate plots for training set</span>
        <span class="n">df_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df_train</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">train_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_generate_evaluation_plots</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">train_preds</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to generate training plots: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="c1"># Generate plots for validation set</span>
        <span class="n">df_validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validation&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df_validation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_validation</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_generate_evaluation_plots</span><span class="p">(</span><span class="n">df_validation</span><span class="p">,</span> <span class="n">val_preds</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;validation&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to generate validation plots: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_hyperparams</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log model hyperparameters to MLflow.</span>

<span class="sd">        Logs all hyperparameters from the ChempropHyperparams dataclass,</span>
<span class="sd">        as well as additional model configuration parameters like</span>
<span class="sd">        smiles_col, target_cols, and parsed data_dir parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Log hyperparams from dataclass</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">)</span>

        <span class="c1"># Add additional configuration</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;smiles_col&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smiles_col</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;target_cols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;n_targets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">)</span>

        <span class="c1"># Parse and log data_dir parameters if available</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">admet.util.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse_data_dir_params</span>

            <span class="n">data_params</span> <span class="o">=</span> <span class="n">parse_data_dir_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">params</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;data.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_logger</span><span class="o">.</span><span class="n">log_hyperparams</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_dataset_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log dataset information to MLflow.</span>

<span class="sd">        Logs dataset sizes as parameters and saves dataset statistics</span>
<span class="sd">        as CSV artifacts for reproducibility.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;_log_dataset_info skipped: mlflow_client or run_id is None&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Logging dataset info to MLflow run </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">)</span>

        <span class="c1"># Log dataset sizes</span>
        <span class="n">df_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
        <span class="n">df_validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validation&quot;</span><span class="p">)</span>
        <span class="n">df_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">df_train</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span> <span class="s2">&quot;train_size&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_train</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">df_validation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span> <span class="s2">&quot;validation_size&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_validation</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">df_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span> <span class="s2">&quot;test_size&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_test</span><span class="p">))</span>

        <span class="c1"># Register datasets with MLflow (run is already active from _init_mlflow)</span>
        <span class="k">if</span> <span class="n">df_train</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_input</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s2">&quot;training&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Registered training dataset with MLflow&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df_validation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">df_validation</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;validation&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_input</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s2">&quot;validation&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Registered validation dataset with MLflow&quot;</span><span class="p">)</span>

        <span class="c1"># Log dataset statistics as CSV artifact</span>
        <span class="k">if</span> <span class="n">df_train</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stats_rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">df_train</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">train_mean</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                    <span class="n">train_std</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
                    <span class="n">stats_rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;split&quot;</span><span class="p">:</span> <span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span> <span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">train_mean</span><span class="p">})</span>
                    <span class="n">stats_rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;split&quot;</span><span class="p">:</span> <span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span> <span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">train_std</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">stats_rows</span><span class="p">:</span>
                <span class="n">df_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">stats_rows</span><span class="p">)</span>
                <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">())</span>
                <span class="n">csv_path</span> <span class="o">=</span> <span class="n">temp_dir</span> <span class="o">/</span> <span class="s2">&quot;train_dataset_stats.csv&quot;</span>
                <span class="n">df_stats</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Logging dataset stats artifact: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">csv_path</span><span class="p">),</span> <span class="n">artifact_path</span><span class="o">=</span><span class="s2">&quot;metrics&quot;</span><span class="p">)</span>
                <span class="n">csv_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">missing_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">temp_dir</span><span class="o">.</span><span class="n">rmdir</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_evaluation_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute and log correlation metrics on validation set.</span>

<span class="sd">        Generates predictions on the validation set and computes</span>
<span class="sd">        correlation metrics (MAE, RMSE, R2, Pearson, Spearman, Kendall)</span>
<span class="sd">        for each target column using the stats.correlation function.</span>

<span class="sd">        When curriculum learning is enabled, also computes per-quality</span>
<span class="sd">        metrics for each quality level present in the validation data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">df_validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validation&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df_validation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Generate predictions on validation set</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">preds_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_validation</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to generate validation predictions: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Compute correlation metrics for each target (overall)</span>
        <span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_validation</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df_validation</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">preds_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="c1"># Compute correlation metrics using stats module</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">correlation</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

            <span class="c1"># Add metrics to output dataframe</span>
            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;split&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">target</span><span class="p">],</span>
                        <span class="s2">&quot;quality&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">metric_name</span><span class="p">],</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">metric_value</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_out</span><span class="p">,</span> <span class="n">row</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Compute per-quality metrics if curriculum learning is enabled</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quality_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">quality_col</span> <span class="ow">in</span> <span class="n">df_validation</span><span class="o">.</span><span class="n">columns</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">quality_labels</span> <span class="o">=</span> <span class="n">df_validation</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">quality_col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">quality_indices</span> <span class="o">=</span> <span class="n">get_quality_indices</span><span class="p">(</span><span class="n">quality_labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curriculum_state</span><span class="o">.</span><span class="n">qualities</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">quality</span><span class="p">,</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">quality_indices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">indices</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Subset the validation data for this quality</span>
                <span class="n">df_quality</span> <span class="o">=</span> <span class="n">df_validation</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
                <span class="n">preds_quality</span> <span class="o">=</span> <span class="n">preds_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_quality</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df_quality</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">preds_quality</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

                    <span class="c1"># Skip if not enough samples for meaningful metrics</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Compute correlation metrics</span>
                    <span class="n">metrics</span> <span class="o">=</span> <span class="n">correlation</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

                    <span class="c1"># Add metrics to output dataframe</span>
                    <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;split&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">],</span>
                                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">target</span><span class="p">],</span>
                                <span class="s2">&quot;quality&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">quality</span><span class="p">],</span>
                                <span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">metric_name</span><span class="p">],</span>
                                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">metric_value</span><span class="p">],</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                        <span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_out</span><span class="p">,</span> <span class="n">row</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                        <span class="c1"># Also log quality-specific metrics directly to MLflow</span>
                        <span class="n">mlflow_metric_name</span> <span class="o">=</span> <span class="n">_sanitize_mlflow_metric_name</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;val_</span><span class="si">{</span><span class="n">quality</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span> <span class="n">mlflow_metric_name</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">metric_value</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>  <span class="c1"># Silently ignore metric logging failures</span>

            <span class="c1"># Log quality distribution in validation set</span>
            <span class="n">quality_counts</span> <span class="o">=</span> <span class="p">{</span><span class="n">q</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">quality_indices</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">indices</span><span class="p">}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validation quality distribution: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">quality_counts</span><span class="p">)</span>

        <span class="c1"># Log metrics as CSV artifact</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df_out</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">df_out</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">())</span>
            <span class="n">csv_path</span> <span class="o">=</span> <span class="n">temp_dir</span> <span class="o">/</span> <span class="s2">&quot;validation_metrics.csv&quot;</span>
            <span class="n">df_out</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">csv_path</span><span class="p">),</span> <span class="n">artifact_path</span><span class="o">=</span><span class="s2">&quot;metrics&quot;</span><span class="p">)</span>
            <span class="n">csv_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">missing_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">temp_dir</span><span class="o">.</span><span class="n">rmdir</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_training_artifacts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">completed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log training artifacts to MLflow.</span>

<span class="sd">        Saves model checkpoint and training configuration.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        completed : bool</span>
<span class="sd">            Whether training completed normally (True) or was</span>
<span class="sd">            interrupted (False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;_log_training_artifacts skipped: mlflow_client or run_id is None&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Logging training artifacts to MLflow run </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">)</span>

        <span class="c1"># Log training completion status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span> <span class="s2">&quot;training_completed&quot;</span><span class="p">,</span> <span class="n">completed</span><span class="p">)</span>

        <span class="c1"># Determine checkpoint directory (could be output_dir or temp dir)</span>
        <span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_temp_dir</span>

        <span class="c1"># Log model checkpoints as artifacts</span>
        <span class="k">if</span> <span class="n">checkpoint_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">checkpoint_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="c1"># Debug: List contents of checkpoint directory</span>
            <span class="n">all_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checkpoint dir (</span><span class="si">%s</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">checkpoint_dir</span><span class="p">,</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">])</span>

            <span class="c1"># Log best checkpoint(s)</span>
            <span class="n">best_checkpoints</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;best-*.ckpt&quot;</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> best checkpoints&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_checkpoints</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">ckpt</span> <span class="ow">in</span> <span class="n">best_checkpoints</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Logging checkpoint: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ckpt</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ckpt</span><span class="p">),</span> <span class="n">artifact_path</span><span class="o">=</span><span class="s2">&quot;checkpoints&quot;</span><span class="p">)</span>

            <span class="c1"># Log last checkpoint if exists</span>
            <span class="n">last_checkpoint</span> <span class="o">=</span> <span class="n">checkpoint_dir</span> <span class="o">/</span> <span class="s2">&quot;last.ckpt&quot;</span>
            <span class="k">if</span> <span class="n">last_checkpoint</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_checkpoint</span><span class="p">),</span> <span class="n">artifact_path</span><span class="o">=</span><span class="s2">&quot;checkpoints&quot;</span><span class="p">)</span>

            <span class="c1"># Log best checkpoint path as param</span>
            <span class="k">if</span> <span class="n">completed</span> <span class="ow">and</span> <span class="n">best_checkpoints</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span> <span class="s2">&quot;best_checkpoint_path&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">best_checkpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># Save hyperparameters as YAML artifact</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>

        <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">())</span>
        <span class="n">yaml_path</span> <span class="o">=</span> <span class="n">temp_dir</span> <span class="o">/</span> <span class="s2">&quot;hyperparameters.yaml&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;smiles_col&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smiles_col</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;target_cols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">yaml_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">yaml_path</span><span class="p">),</span> <span class="n">artifact_path</span><span class="o">=</span><span class="s2">&quot;config&quot;</span><span class="p">)</span>
        <span class="n">yaml_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">missing_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">temp_dir</span><span class="o">.</span><span class="n">rmdir</span><span class="p">()</span>

        <span class="c1"># Register the model with MLflow (run is already active from _init_mlflow)</span>
        <span class="k">if</span> <span class="n">completed</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpnn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mpnn</span><span class="p">,</span>
                <span class="n">artifact_path</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">,</span>
                <span class="n">registered_model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Don&#39;t auto-register to model registry</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Registered PyTorch model with MLflow&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ChempropModel.predict">
<a class="viewcode-back" href="../../../../api/admet.model.html#admet.model.chemprop.ChempropModel.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">generate_plots</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">split_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate predictions for a dataframe.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pandas.DataFrame</span>
<span class="sd">            Input dataframe containing SMILES column. Target columns</span>
<span class="sd">            are optional (used if present for dataset creation).</span>
<span class="sd">        generate_plots : bool, default=False</span>
<span class="sd">            Whether to generate parity plots for predictions when</span>
<span class="sd">            ground truth is available.</span>
<span class="sd">        split_name : str, default=&#39;test&#39;</span>
<span class="sd">            Split name for labeling plots when generate_plots is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            Predictions with columns named after target columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">smis</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">smis</span> <span class="o">=</span> <span class="n">parallel_canonicalize_smiles</span><span class="p">(</span><span class="n">smis</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="c1"># gracefully handle labelled/unlabelled data</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">datapoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">MoleculeDatapoint</span><span class="o">.</span><span class="n">from_smi</span><span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">smi</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">smis</span><span class="p">,</span> <span class="n">ys</span><span class="p">)]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Split &#39;</span><span class="si">%s</span><span class="s2">&#39;: Generating predictions for </span><span class="si">%d</span><span class="s2"> labelled molecules&quot;</span><span class="p">,</span> <span class="n">split_name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">datapoints</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">datapoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">MoleculeDatapoint</span><span class="o">.</span><span class="n">from_smi</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span> <span class="k">for</span> <span class="n">smi</span> <span class="ow">in</span> <span class="n">smis</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Split &#39;</span><span class="si">%s</span><span class="s2">&#39;: Generating predictions for </span><span class="si">%d</span><span class="s2"> unlabelled molecules&quot;</span><span class="p">,</span> <span class="n">split_name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">datapoints</span><span class="p">))</span>

        <span class="n">dataset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">MoleculeDataset</span><span class="p">(</span><span class="n">datapoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizer</span><span class="p">)</span>
        <span class="n">dataloader</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">build_dataloader</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mpnn</span><span class="p">,</span> <span class="n">dataloaders</span><span class="o">=</span><span class="n">dataloader</span><span class="p">)</span>

        <span class="c1"># Collect predictions from batches</span>
        <span class="c1"># results is a list of prediction tensors from each batch</span>
        <span class="n">all_preds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">batch_preds</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="c1"># batch_preds is a tensor of shape [batch_size, n_tasks]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">batch_preds</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                <span class="n">preds</span> <span class="o">=</span> <span class="n">batch_preds</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_preds</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;preds&quot;</span> <span class="ow">in</span> <span class="n">batch_preds</span><span class="p">:</span>
                <span class="n">preds</span> <span class="o">=</span> <span class="n">batch_preds</span><span class="p">[</span><span class="s2">&quot;preds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">preds</span> <span class="o">=</span> <span class="n">batch_preds</span>
            <span class="n">all_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>

        <span class="n">all_preds_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">all_preds</span><span class="p">)</span>
        <span class="n">pred_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_preds_arr</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">])</span>

        <span class="c1"># Log prediction metrics if ground truth is available and MLflow tracking is enabled</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_prediction_metrics</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pred_df</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split_name</span><span class="p">)</span>

        <span class="c1"># Generate plots if requested and ground truth is available</span>
        <span class="k">if</span> <span class="n">generate_plots</span> <span class="ow">and</span> <span class="n">ys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_evaluation_plots</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pred_df</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split_name</span><span class="p">)</span>

        <span class="c1"># Log predictions CSV and submissions CSV with transformed values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_prediction_artifacts</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pred_df</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pred_df</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_log_prediction_artifacts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">pred_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">split</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log prediction artifacts including submissions CSV and distribution stats.</span>

<span class="sd">        Creates and logs:</span>
<span class="sd">        1. Raw predictions CSV</span>
<span class="sd">        2. Submissions CSV with Log columns transformed by 10^x</span>
<span class="sd">        3. Distribution statistics CSV for both raw and transformed predictions</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pd.DataFrame</span>
<span class="sd">            Input dataframe containing SMILES column.</span>
<span class="sd">        pred_df : pd.DataFrame</span>
<span class="sd">            Predictions dataframe.</span>
<span class="sd">        split : str, default=&#39;test&#39;</span>
<span class="sd">            Split name for labeling artifacts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Determine where to save artifacts</span>
        <span class="n">should_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">should_save</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Create temp directory for artifacts if using MLflow</span>
        <span class="n">temp_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">())</span>
            <span class="n">artifact_dir</span> <span class="o">=</span> <span class="n">temp_dir</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">artifact_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;predictions&quot;</span>
            <span class="n">artifact_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Create predictions dataframe with SMILES</span>
        <span class="n">predictions_csv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smiles_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">predictions_csv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Add raw predictions</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">pred_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">predictions_csv</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Save raw predictions</span>
        <span class="n">raw_path</span> <span class="o">=</span> <span class="n">artifact_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">_predictions.csv&quot;</span>
        <span class="n">predictions_csv</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Saved raw predictions to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">raw_path</span><span class="p">)</span>

        <span class="c1"># Create submissions CSV with transformed values (10^x for Log columns)</span>
        <span class="n">submissions_csv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smiles_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">submissions_csv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">pred_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Log &quot;</span><span class="p">):</span>
                    <span class="c1"># Transform Log columns: 10^x</span>
                    <span class="n">transformed_name</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Log &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">submissions_csv</span><span class="p">[</span><span class="n">transformed_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">submissions_csv</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>

        <span class="n">submissions_path</span> <span class="o">=</span> <span class="n">artifact_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">_submissions.csv&quot;</span>
        <span class="n">submissions_csv</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">submissions_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Saved submissions to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">submissions_path</span><span class="p">)</span>

        <span class="c1"># Compute and save distribution statistics</span>
        <span class="n">stats_rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stats_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pred_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">raw_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">raw_stats</span> <span class="o">=</span> <span class="n">distribution</span><span class="p">(</span><span class="n">raw_values</span><span class="p">)</span>

            <span class="c1"># Add raw stats</span>
            <span class="k">for</span> <span class="n">stat_name</span><span class="p">,</span> <span class="n">stat_value</span> <span class="ow">in</span> <span class="n">raw_stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">stats_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;split&quot;</span><span class="p">:</span> <span class="n">split</span><span class="p">,</span>
                        <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span>
                        <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="s2">&quot;raw&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;statistic&quot;</span><span class="p">:</span> <span class="n">stat_name</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">stat_value</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

            <span class="c1"># Add transformed stats for Log columns</span>
            <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Log &quot;</span><span class="p">):</span>
                <span class="n">transformed_name</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Log &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">transformed_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">raw_values</span><span class="p">)</span>
                <span class="n">transformed_stats</span> <span class="o">=</span> <span class="n">distribution</span><span class="p">(</span><span class="n">transformed_values</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">stat_name</span><span class="p">,</span> <span class="n">stat_value</span> <span class="ow">in</span> <span class="n">transformed_stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">stats_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;split&quot;</span><span class="p">:</span> <span class="n">split</span><span class="p">,</span>
                            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">transformed_name</span><span class="p">,</span>
                            <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="s2">&quot;10^x&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;statistic&quot;</span><span class="p">:</span> <span class="n">stat_name</span><span class="p">,</span>
                            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">stat_value</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="n">stats_rows</span><span class="p">:</span>
            <span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">stats_rows</span><span class="p">)</span>
            <span class="n">stats_path</span> <span class="o">=</span> <span class="n">artifact_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">_distribution_stats.csv&quot;</span>
            <span class="n">stats_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">stats_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Saved distribution stats to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">stats_path</span><span class="p">)</span>

        <span class="c1"># Log artifacts to MLflow</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">temp_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">raw_path</span><span class="p">),</span> <span class="n">artifact_path</span><span class="o">=</span><span class="s2">&quot;predictions&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">submissions_path</span><span class="p">),</span> <span class="n">artifact_path</span><span class="o">=</span><span class="s2">&quot;predictions&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stats_rows</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">stats_path</span><span class="p">),</span> <span class="n">artifact_path</span><span class="o">=</span><span class="s2">&quot;predictions&quot;</span><span class="p">)</span>

            <span class="c1"># Clean up temp directory</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_prediction_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pred_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">split</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;predict&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log correlation metrics for predictions if ground truth is available.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pd.DataFrame</span>
<span class="sd">            Input dataframe that may contain ground truth target columns.</span>
<span class="sd">        pred_df : pd.DataFrame</span>
<span class="sd">            Predictions dataframe.</span>
<span class="sd">        split : str, default=&#39;predict&#39;</span>
<span class="sd">            Split name prefix for metric logging.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Check if any target columns have ground truth</span>
        <span class="n">has_targets</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_targets</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">all_metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Collect metrics for averaging</span>

        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="c1"># Compute correlation metrics using stats module</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">correlation</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

            <span class="c1"># Log each metric to MLflow directly with test/ prefix</span>
            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Create sanitized metric key: test/&lt;target&gt;_&lt;metric&gt;</span>
                <span class="n">safe_target</span> <span class="o">=</span> <span class="n">_sanitize_mlflow_metric_name</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                <span class="n">mlflow_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">safe_target</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span> <span class="n">mlflow_key</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">metric_value</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># Silently ignore metric logging failures</span>

                <span class="c1"># Collect for averaging</span>
                <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_metrics</span><span class="p">:</span>
                    <span class="n">all_metrics</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">metric_val_float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">metric_value</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">metric_val_float</span><span class="p">):</span>
                    <span class="n">all_metrics</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_val_float</span><span class="p">)</span>

                <span class="c1"># Save to dataframe for artifact</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;split&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">split</span><span class="p">],</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">metric_name</span><span class="p">],</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">metric_value</span><span class="p">]}</span>
                <span class="p">)</span>
                <span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_out</span><span class="p">,</span> <span class="n">row</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Log mean metrics across all targets</span>
        <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">all_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">mean_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
                <span class="n">mlflow_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">/mean_</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span> <span class="n">mlflow_key</span><span class="p">,</span> <span class="n">mean_value</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">df_out</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">df_out</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">())</span>
            <span class="n">csv_path</span> <span class="o">=</span> <span class="n">temp_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">_prediction_metrics.csv&quot;</span>
            <span class="n">df_out</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">csv_path</span><span class="p">),</span> <span class="n">artifact_path</span><span class="o">=</span><span class="s2">&quot;metrics&quot;</span><span class="p">)</span>
            <span class="n">csv_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">missing_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">temp_dir</span><span class="o">.</span><span class="n">rmdir</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_evaluation_plots</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df_true</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">pred_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">split</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;validation&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate parity plots for model evaluation.</span>

<span class="sd">        Creates parity plots comparing true vs predicted values for each</span>
<span class="sd">        target column. Plots are logged to MLflow if active, saved to</span>
<span class="sd">        output_dir if specified, or skipped otherwise.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df_true : pd.DataFrame</span>
<span class="sd">            Ground truth dataframe with target columns.</span>
<span class="sd">        pred_df : pd.DataFrame</span>
<span class="sd">            Predictions dataframe.</span>
<span class="sd">        split : str, default=&#39;validation&#39;</span>
<span class="sd">            Split name for labeling plots.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if any target columns have ground truth</span>
        <span class="n">has_targets</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="ow">in</span> <span class="n">df_true</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_targets</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Determine if we should save plots</span>
        <span class="n">should_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">should_save</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Create temp directory for plots if using MLflow</span>
        <span class="n">temp_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_tracking</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">())</span>
            <span class="n">plot_dir</span> <span class="o">=</span> <span class="n">temp_dir</span> <span class="o">/</span> <span class="s2">&quot;plots&quot;</span> <span class="o">/</span> <span class="n">split</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;plots&quot;</span> <span class="o">/</span> <span class="n">split</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">plot_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Generate parity plots for each target</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_true</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df_true</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="kn">from</span><span class="w"> </span><span class="nn">admet.plot</span><span class="w"> </span><span class="kn">import</span> <span class="n">GLASBEY_PALETTE</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">admet.plot.latex</span><span class="w"> </span><span class="kn">import</span> <span class="n">latex_sanitize</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_parity</span><span class="p">(</span>
                <span class="n">y_true</span><span class="p">,</span>
                <span class="n">y_pred</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">latex_sanitize</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">GLASBEY_PALETTE</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">GLASBEY_PALETTE</span><span class="p">)],</span>
            <span class="p">)</span>

            <span class="c1"># Create safe filename</span>
            <span class="n">safe_name</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;lt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;gt&quot;</span><span class="p">)</span>
            <span class="n">plot_path</span> <span class="o">=</span> <span class="n">plot_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;parity_</span><span class="si">{</span><span class="n">safe_name</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="c1"># Generate metric bar charts</span>
        <span class="n">metrics_df</span> <span class="o">=</span> <span class="n">compute_metrics_df</span><span class="p">(</span><span class="n">df_true</span><span class="p">,</span> <span class="n">pred_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metrics_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">admet.plot.latex</span><span class="w"> </span><span class="kn">import</span> <span class="n">latex_sanitize</span> <span class="k">as</span> <span class="n">sanitize_label</span>

            <span class="k">for</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">METRIC_NAMES</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metrics_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">metrics_df</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">sanitize_label</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="n">metrics_df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

                <span class="n">fig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plot_metric_bar</span><span class="p">(</span>
                    <span class="n">values</span><span class="p">,</span>
                    <span class="n">labels</span><span class="p">,</span>
                    <span class="n">metric_name</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">safe_metric</span> <span class="o">=</span> <span class="n">metric_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                <span class="n">plot_path</span> <span class="o">=</span> <span class="n">plot_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;metric_</span><span class="si">{</span><span class="n">safe_metric</span><span class="si">}</span><span class="s2">.png&quot;</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="c1"># Save predictions as CSV artifact</span>
        <span class="n">predictions_dir</span> <span class="o">=</span> <span class="n">plot_dir</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;predictions&quot;</span>
        <span class="n">predictions_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Create combined dataframe with SMILES, ground truth, and predictions</span>
        <span class="n">predictions_csv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smiles_col</span> <span class="ow">in</span> <span class="n">df_true</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">predictions_csv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_true</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">df_true</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">predictions_csv</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">_true&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_true</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">pred_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">predictions_csv</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">_pred&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">predictions_path</span> <span class="o">=</span> <span class="n">predictions_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">_predictions.csv&quot;</span>
        <span class="n">predictions_csv</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">predictions_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Log plots and predictions to MLflow</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Log all files in the plot directory</span>
            <span class="k">for</span> <span class="n">plot_file</span> <span class="ow">in</span> <span class="n">plot_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">plot_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">plot_file</span><span class="p">),</span> <span class="n">artifact_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;plots/</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Log predictions CSV</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mlflow_client</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlflow_run_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">predictions_path</span><span class="p">),</span> <span class="n">artifact_path</span><span class="o">=</span><span class="s2">&quot;predictions&quot;</span><span class="p">)</span>

            <span class="c1"># Clean up temp directory (only exists when using MLflow)</span>
            <span class="k">if</span> <span class="n">temp_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>

                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">train_from_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train a ChempropModel from a YAML configuration file.</span>

<span class="sd">    This function loads the configuration from a YAML file, creates a model,</span>
<span class="sd">    trains it, and generates predictions for test and blind datasets if specified.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config_path : str</span>
<span class="sd">        Path to the YAML configuration file.</span>
<span class="sd">    log_level : str, default=&quot;INFO&quot;</span>
<span class="sd">        Logging level. Options: &quot;DEBUG&quot;, &quot;INFO&quot;, &quot;WARNING&quot;, &quot;ERROR&quot;.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; train_from_config(&quot;configs/example_chemprop.yaml&quot;)</span>
<span class="sd">    &gt;&gt;&gt; train_from_config(&quot;configs/experiment.yaml&quot;, log_level=&quot;DEBUG&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Configure logging</span>
    <span class="n">numeric_level</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">log_level</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">numeric_level</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
        <span class="n">level</span><span class="o">=</span><span class="n">numeric_level</span><span class="p">,</span>
        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading configuration from: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">config_path</span><span class="p">)</span>

    <span class="c1"># Load configuration from YAML</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">OmegaConf</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">OmegaConf</span><span class="o">.</span><span class="n">structured</span><span class="p">(</span><span class="n">ChempropConfig</span><span class="p">),</span>
        <span class="n">OmegaConf</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config_path</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Log the configuration</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Configuration:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">OmegaConf</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>

    <span class="c1"># Create model from config</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating model from configuration...&quot;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ChempropModel</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>

    <span class="c1"># Train the model</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting training...&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="c1"># Generate predictions for test set if available</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">dataframes</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating predictions for test set...&quot;</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">dataframes</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">],</span>
            <span class="n">generate_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">split_name</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Generate predictions for blind set if available</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">dataframes</span><span class="p">[</span><span class="s2">&quot;blind&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating predictions for blind set...&quot;</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">dataframes</span><span class="p">[</span><span class="s2">&quot;blind&quot;</span><span class="p">],</span>
            <span class="n">generate_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">split_name</span><span class="o">=</span><span class="s2">&quot;blind&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Export config for reproducibility</span>
    <span class="n">exported_config</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to_config</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Exported config:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">OmegaConf</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="n">OmegaConf</span><span class="o">.</span><span class="n">structured</span><span class="p">(</span><span class="n">exported_config</span><span class="p">)))</span>

    <span class="c1"># Close the MLflow run when done</span>
    <span class="n">model</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Training complete!&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CLI entrypoint for training a ChempropModel from a YAML configuration.</span>

<span class="sd">    Usage</span>
<span class="sd">    -----</span>
<span class="sd">    python -m admet.model.chemprop.model --config configs/example_chemprop.yaml</span>
<span class="sd">    python -m admet.model.chemprop.model -c configs/experiment.yaml --log-level DEBUG</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Train a Chemprop MPNN model from a YAML configuration file.&quot;</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span>
        <span class="n">epilog</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Examples:</span>
<span class="s2">  python -m admet.model.chemprop.model --config configs/example_chemprop.yaml</span>
<span class="s2">  python -m admet.model.chemprop.model -c configs/experiment.yaml --log-level DEBUG</span>

<span class="s2">Configuration file format:</span>
<span class="s2">  See configs/example_chemprop.yaml for a complete example.</span>
<span class="s2">  The configuration has four sections:</span>
<span class="s2">    - data: File paths and column specifications</span>
<span class="s2">    - model: Neural network architecture settings</span>
<span class="s2">    - optimization: Training hyperparameters</span>
<span class="s2">    - mlflow: Experiment tracking settings</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--config&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to YAML configuration file&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--log-level&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span> <span class="s2">&quot;WARNING&quot;</span><span class="p">,</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Logging level (default: INFO)&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">train_from_config</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Alec Glisman, Ph.D.
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../../_static/documentation_options.js?v=8a448e45"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../../_static/copybutton.js?v=6dbb43f8"></script>
    </body>
</html>